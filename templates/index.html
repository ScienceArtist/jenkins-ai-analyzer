<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jenkins Log Analyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f0f0; min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 8px; padding: 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #333; margin-bottom: 10px; text-align: center; font-size: 2.5em; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .step { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #335eea; }
        .step h2 { color: #335eea; margin-bottom: 15px; font-size: 1.2em; }
        input, select, button { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; border-radius: 4px; font-size: 16px; }
        input:focus, select:focus { outline: none; border-color: #335eea; }
        button { background: #335eea; color: white; border: none; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        button:hover { background: #2347c5; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .progress-section { display: none; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0; }
        .progress-section.active { display: block; }
        .progress-bar { width: 100%; height: 30px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: #335eea; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .status-message { color: #335eea; font-weight: bold; margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border: 1px solid #e0e0e0; }

        /* Jenkins-style Pipeline View */
        .results-section { display: none; margin-top: 30px; background: #f8f9fa; padding: 20px; border-radius: 8px; }
        .results-section.active { display: block; }

        .pipeline-view { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #d9d9d9; }
        .pipeline-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .pipeline-title { font-size: 1.5em; font-weight: bold; color: #333; }
        .pipeline-meta { display: flex; gap: 15px; align-items: center; }

        /* Stage boxes with arrows */
        .stages-container { display: flex; align-items: center; gap: 0; margin: 20px 0; overflow-x: auto; padding: 10px 0; }
        .stage-box {
            min-width: 180px;
            background: white;
            border: 2px solid #d9d9d9;
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }
        .stage-box:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .stage-box.success { border-color: #4caf50; background: #f1f8f4; }
        .stage-box.failure { border-color: #f44336; background: #fef1f0; }
        .stage-box.unstable { border-color: #ff9800; background: #fff8e1; }
        .stage-box.running { border-color: #2196f3; background: #e3f2fd; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stage-icon { font-size: 2em; margin-bottom: 8px; }
        .stage-box.success .stage-icon { color: #4caf50; }
        .stage-box.failure .stage-icon { color: #f44336; }
        .stage-box.unstable .stage-icon { color: #ff9800; }
        .stage-box.running .stage-icon { color: #2196f3; }

        .stage-name { font-weight: bold; color: #333; margin-bottom: 5px; font-size: 0.95em; }
        .stage-duration { font-size: 0.85em; color: #666; }

        .arrow {
            width: 40px;
            height: 2px;
            background: #d9d9d9;
            position: relative;
            flex-shrink: 0;
        }
        .arrow::after {
            content: '‚ñ∂';
            position: absolute;
            right: -8px;
            top: -9px;
            color: #d9d9d9;
            font-size: 12px;
        }

        /* Job cards - Jenkins style */
        .job-card {
            background: white;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .job-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .job-header {
            background: #fafafa;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }
        .job-header:hover { background: #f0f0f0; }

        .job-title-section { display: flex; align-items: center; gap: 12px; }
        .build-status-icon { font-size: 1.5em; }
        .job-title { font-size: 1.1em; font-weight: 600; color: #333; }
        .job-meta { display: flex; gap: 12px; font-size: 0.9em; align-items: center; }
        .job-badge {
            background: #e0e0e0;
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            color: #555;
        }
        .job-badge.rca { background: #e3f2fd; color: #1976d2; font-weight: 600; }

        .job-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .job-content.expanded { max-height: 5000px; }
        .job-body {
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .expand-icon { transition: transform 0.3s; color: #666; }
        .expanded-header .expand-icon { transform: rotate(180deg); }

        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; border: 1px solid #d9d9d9; padding: 20px; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #335eea; }
        .stat-label { font-size: 0.9em; color: #666; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 8px; max-width: 600px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-header { color: #335eea; font-size: 1.5em; margin-bottom: 20px; }
        .modal-body { line-height: 1.8; color: #333; }
        .modal-body strong { color: #335eea; }
        .modal-body a { color: #335eea; text-decoration: none; font-weight: bold; }
        .modal-body a:hover { text-decoration: underline; }
        .close-btn { float: right; font-size: 28px; font-weight: bold; color: #aaa; cursor: pointer; }
        .close-btn:hover { color: #000; }
        .footer { margin-top: 40px; padding: 20px; text-align: center; color: #666; border-top: 2px solid #f0f0f0; }
        .footer a { color: #335eea; text-decoration: none; }
        .export-buttons { display: none; margin-top: 20px; gap: 10px; }
        .export-buttons.active { display: flex; }
        .export-btn { flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .export-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Jenkins Log Analyzer</h1>
        <p class="subtitle">AI-powered analysis with real-time streaming results</p>
        
        <div class="step">
            <h2>Step 1: Enter Groq API Key</h2>
            <input type="password" id="groqApiKey" placeholder="Enter your Groq API key">
            <button onclick="fetchModels()">Fetch Available Models</button>
            <small style="color: #dc3545; margin-top: 10px; display: block;">‚ö†Ô∏è <a href="#" onclick="showDataProtectionModal(); return false;" style="color: #dc3545; text-decoration: underline;">Important: Enable Zero Data Retention in Groq</a></small>
        </div>
        
        <div class="step">
            <h2>Step 2: Select Model</h2>
            <select id="modelSelect" disabled>
                <option value="">First fetch models...</option>
            </select>
        </div>
        
        <div class="step">
            <h2>Step 3: Enter Jenkins URL</h2>
            <input type="text" id="jenkinsUrl" placeholder="https://your-jenkins-server.com or https://jenkins.com/job/JobName/">
            <small style="color: #666;">üí° Tip: Use base URL to analyze all jobs, or job-specific URL for single job</small>
        </div>

        <div class="step">
            <h2>Step 4: Analysis Options</h2>
            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" id="filterFailed" checked style="width: auto; margin: 0;">
                    <span><strong>üîç Smart Filter:</strong> Only analyze failed/unstable jobs (reduces analysis by ~80%)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" id="enableRCA" checked style="width: auto; margin: 0;">
                    <span><strong>üî¨ Root Cause Analysis:</strong> Deep dive into failures with actionable insights</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px;">
                    <input type="checkbox" id="enableParallel" checked style="width: auto; margin: 0;">
                    <span><strong>üöÄ Parallel Processing:</strong> Use 3 workers for 10x faster analysis</span>
                </label>
            </div>
        </div>

        <div class="step">
            <h2>Step 5: Analyze Logs</h2>
            <button id="analyzeBtn" onclick="analyzeLogs()">Start Analysis</button>
        </div>

        <div id="progressSection" class="progress-section">
            <h3 style="color: #335eea; margin-bottom: 15px;">‚öôÔ∏è Analysis Progress</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
            </div>
            <div id="statusMessage" class="status-message">Initializing...</div>
        </div>
        
        <div id="resultsSection" class="results-section">
            <!-- Pipeline View Header -->
            <div class="pipeline-view" id="pipelineView" style="display: none;">
                <div class="pipeline-header">
                    <div>
                        <div class="pipeline-title" id="pipelineName">Pipeline Analysis</div>
                        <div style="color: #666; margin-top: 5px;" id="pipelineDesc"></div>
                    </div>
                    <div class="pipeline-meta">
                        <div style="font-size: 0.9em; color: #666;">
                            <span id="pipelineJobCount">0</span> jobs
                        </div>
                    </div>
                </div>

                <!-- Pipeline Stages with Arrows -->
                <div class="stages-container" id="stagesContainer">
                    <!-- Stages will be dynamically added here -->
                </div>
            </div>

            <!-- Summary Stats -->
            <div id="summaryStats" class="summary-stats"></div>

            <!-- Job Results -->
            <div id="jobResults"></div>

            <!-- Export Buttons -->
            <div class="export-buttons" id="exportButtons">
                <button class="export-btn" onclick="exportAsJSON()">üì• Export as JSON</button>
                <button class="export-btn" onclick="exportAsXML()">üßæ Export as XML</button>
            </div>
        </div>

	        <div class="footer">
	            <p>Created by <strong>Chandravijay Agrawal</strong> | <a href="https://github.com/ScienceArtist" target="_blank">@ScienceArtist</a></p>
            <p style="margin-top: 10px; font-size: 0.9em;">AI-powered Jenkins Log Analyzer with real-time streaming</p>
        </div>
    </div>

    <!-- Data Protection Modal -->
    <div id="dataProtectionModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDataProtectionModal()">&times;</span>
            <div class="modal-header">üîí Important: Enable Zero Data Retention</div>
            <div class="modal-body">
                <p><strong>To protect your Jenkins logs and data, you MUST enable Zero Data Retention (ZDR) in Groq:</strong></p>
                <ol style="margin: 15px 0; padding-left: 20px;">
                    <li>Visit <a href="https://console.groq.com/settings/data-controls" target="_blank">Groq Data Controls Settings</a></li>
                    <li>Enable <strong>"Global ZDR"</strong> - This prevents Groq from storing any input/output data</li>
                    <li>Enable <strong>"Inference APIs ZDR"</strong> - This opts out of storing API data for 30 days</li>
                </ol>
                <p style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>‚ö†Ô∏è Why this matters:</strong> Without ZDR enabled, your Jenkins logs (which may contain sensitive information) could be stored by Groq for up to 30 days. Enabling ZDR ensures complete data privacy.
                </p>
                <button onclick="closeDataProtectionModal()" style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Got it!</button>
            </div>
        </div>
    </div>

	    <script>
        let jobCount = 0, analyzedCount = 0;
        let analysisResults = [];

        function showDataProtectionModal() {
            document.getElementById('dataProtectionModal').style.display = 'block';
        }

        function closeDataProtectionModal() {
            document.getElementById('dataProtectionModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('dataProtectionModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Check for automation query parameters on page load
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const groqApiKey = urlParams.get('groq_api_key');
            const model = urlParams.get('model');
            const jenkinsUrl = urlParams.get('jenkins_url');

            if (groqApiKey && model && jenkinsUrl) {
                // Auto-fill form fields
                document.getElementById('groqApiKey').value = groqApiKey;
                document.getElementById('jenkinsUrl').value = jenkinsUrl;

                // Trigger async analysis for automation
                triggerAsyncAnalysis(groqApiKey, model, jenkinsUrl);
            }
        });

        async function triggerAsyncAnalysis(apiKey, model, jenkinsUrl) {
            try {
                document.getElementById('statusMessage').textContent = 'Starting async analysis...';
                document.getElementById('progressSection').classList.add('active');

                const res = await fetch('/api/analyze-async', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jenkins_url: jenkinsUrl,
                        groq_api_key: apiKey,
                        model: model
                    })
                });

                const data = await res.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Display tracking information
                const trackingInfo = document.createElement('div');
                trackingInfo.style.cssText = 'background: #e7f3ff; border: 2px solid #2196F3; padding: 20px; border-radius: 10px; margin: 20px 0;';
                trackingInfo.innerHTML = `
                    <h3 style="color: #1976D2; margin-top: 0;">üîó Async Analysis Started</h3>
                    <p><strong>Tracking ID:</strong> <code style="background: white; padding: 4px 8px; border-radius: 4px;">${data.tracking_id}</code></p>
                    <p><strong>Status URL:</strong> <a href="${data.status_url}" target="_blank" style="color: #1976D2; word-break: break-all;">${data.status_url}</a></p>
                    <p style="margin-bottom: 0;"><strong>Status:</strong> <span style="color: #ff9800; font-weight: bold;">${data.status}</span></p>
                    <button onclick="pollAsyncStatus('${data.tracking_id}')" style="margin-top: 15px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìä Poll Status & Show Results</button>
                `;

                document.getElementById('resultsSection').classList.add('active');
                document.getElementById('resultsSection').insertBefore(trackingInfo, document.getElementById('summaryStats'));

            } catch (e) {
                alert('Error starting async analysis: ' + e.message);
            }
        }

        async function pollAsyncStatus(trackingId) {
            try {
                document.getElementById('statusMessage').textContent = 'Polling analysis status...';

                const res = await fetch(`/api/status/${trackingId}`);
                const data = await res.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                document.getElementById('statusMessage').textContent = `Status: ${data.status}`;

                if (data.status === 'complete' && data.results) {
                    // Display results
                    analysisResults = data.results;
                    document.getElementById('jobResults').innerHTML = '';

                    // Show pipeline info if available
                    if (data.pipeline) {
                        document.getElementById('pipelineInfo').style.display = 'block';
                        document.getElementById('pipelineName').textContent = data.pipeline.name;
                        document.getElementById('pipelineDesc').textContent = `Pipeline with ${data.pipeline.job_count} jobs`;
                    }

                    // Display each job result
                    data.results.forEach(result => {
                        const card = document.createElement('div');
                        card.className = 'job-card';
                        card.innerHTML = `
                            <div class="job-header" onclick="this.nextElementSibling.classList.toggle('expanded')">
                                <div class="job-title">${result.job}</div>
                                <div class="job-meta">
                                    <div class="job-badge">Build #${result.build}</div>
                                    <div class="job-badge">${(result.log_size/1024).toFixed(1)}KB</div>
                                    <div class="expand-icon">‚ñº</div>
                                </div>
                            </div>
                            <div class="job-content expanded">
                                <div class="job-body">${result.analysis}</div>
                            </div>
                        `;
                        document.getElementById('jobResults').appendChild(card);
                    });

                    updateStats();
                    document.getElementById('exportButtons').classList.add('active');
                    document.getElementById('statusMessage').textContent = '‚úÖ Analysis complete!';

                } else if (data.status === 'pending' || data.status === 'running') {
                    document.getElementById('statusMessage').textContent = `Status: ${data.status} - Click "Poll Status" again to refresh`;
                } else {
                    document.getElementById('statusMessage').textContent = `Status: ${data.status}`;
                }

            } catch (e) {
                alert('Error polling status: ' + e.message);
            }
        }
        
        async function fetchModels() {
            const apiKey = document.getElementById('groqApiKey').value;
            if (!apiKey) { alert('Enter API key'); return; }
            try {
                const res = await fetch('/api/models', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({groq_api_key: apiKey}) });
                const data = await res.json();
                if (data.error) { alert('Error: ' + data.error); return; }
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="">Select model...</option>';
                data.models.forEach(m => { const opt = document.createElement('option'); opt.value = m.id; opt.textContent = m.name; select.appendChild(opt); });
                select.disabled = false;
                alert('‚úì Models loaded!');
            } catch (e) { alert('Error: ' + e.message); }
        }
        
        async function analyzeLogs() {
            const apiKey = document.getElementById('groqApiKey').value;
            const model = document.getElementById('modelSelect').value;
            const jenkinsUrl = document.getElementById('jenkinsUrl').value;

            // Get optimization options
            const filterFailed = document.getElementById('filterFailed').checked;
            const enableRCA = document.getElementById('enableRCA').checked;
            const enableParallel = document.getElementById('enableParallel').checked;
            const parallelWorkers = enableParallel ? 3 : 1;

            if (!apiKey || !model || !jenkinsUrl) { alert('Complete all steps'); return; }
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('resultsSection').classList.add('active');
            document.getElementById('jobResults').innerHTML = '';
            jobCount = 0; analyzedCount = 0;
            analysisResults = []; // Reset results
            document.getElementById('exportButtons').classList.remove('active');
            try {
                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jenkins_url: jenkinsUrl,
                        groq_api_key: apiKey,
                        model: model,
                        filter_failed: filterFailed,
                        enable_rca: enableRCA,
                        parallel_workers: parallelWorkers
                    })
                });
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            if (data.type === 'status') document.getElementById('statusMessage').textContent = data.message;
                            else if (data.type === 'optimization') {
                                // Show optimization message
                                document.getElementById('statusMessage').textContent = data.message;
                            }
                            else if (data.type === 'pipeline_info') {
                                document.getElementById('pipelineView').style.display = 'block';
                                document.getElementById('pipelineName').textContent = 'üîó ' + data.pipeline;
                                document.getElementById('pipelineDesc').textContent = `Analyzing ${data.job_count} jobs in this pipeline`;
                                document.getElementById('pipelineJobCount').textContent = data.job_count;
                            }
                            else if (data.type === 'progress') {
                                jobCount = data.total; analyzedCount = data.current;
                                const pct = Math.round((data.current / data.total) * 100);
                                document.getElementById('progressFill').style.width = pct + '%';
                                document.getElementById('progressFill').textContent = pct + '%';
                                document.getElementById('statusMessage').textContent = `Analyzing ${data.job} (${data.current}/${data.total})`;
                            }
                            else if (data.type === 'job_result') {
                                // Store result for export
                                analysisResults.push({
                                    job: data.job,
                                    build: data.build,
                                    analysis: data.analysis,
                                    log_size: data.log_size,
                                    mode: data.mode || 'Analysis',
                                    timestamp: new Date().toISOString()
                                });

                                // Determine build status from analysis
                                const analysisLower = data.analysis.toLowerCase();
                                let buildStatus = 'success';
                                let statusIcon = 'üîµ';
                                if (analysisLower.includes('failure') || analysisLower.includes('failed')) {
                                    buildStatus = 'failure';
                                    statusIcon = 'üî¥';
                                } else if (analysisLower.includes('unstable') || analysisLower.includes('warning')) {
                                    buildStatus = 'unstable';
                                    statusIcon = 'üü°';
                                }

                                const modeLabel = data.mode || 'üìä Analysis';
                                const isRCA = modeLabel.includes('RCA');

                                const card = document.createElement('div');
                                card.className = 'job-card';
                                card.innerHTML = `
                                    <div class="job-header" onclick="toggleJobCard(this)">
                                        <div class="job-title-section">
                                            <span class="build-status-icon">${statusIcon}</span>
                                            <span class="job-title">${data.job}</span>
                                        </div>
                                        <div class="job-meta">
                                            ${isRCA ? '<div class="job-badge rca">üî¨ RCA</div>' : '<div class="job-badge">üìä Analysis</div>'}
                                            <div class="job-badge">Build #${data.build}</div>
                                            <div class="job-badge">${(data.log_size/1024).toFixed(1)}KB</div>
                                            <span class="expand-icon">‚ñº</span>
                                        </div>
                                    </div>
                                    <div class="job-content">
                                        <div class="job-body">${escapeHtml(data.analysis)}</div>
                                    </div>
                                `;
                                document.getElementById('jobResults').appendChild(card);
                                updateStats();
                            }
                            else if (data.type === 'complete') {
                                document.getElementById('statusMessage').textContent = '‚úÖ ' + data.message;
                                document.getElementById('progressFill').style.width = '100%';
                                document.getElementById('progressFill').textContent = '100%';
                                document.getElementById('exportButtons').classList.add('active'); // Show export buttons
                            }
                        }
                    }
                }
            } catch (e) { alert('Error: ' + e.message); }
            document.getElementById('analyzeBtn').disabled = false;
        }
        
        function toggleJobCard(headerElement) {
            const content = headerElement.nextElementSibling;
            content.classList.toggle('expanded');
            headerElement.classList.toggle('expanded-header');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateStats() {
            const stats = document.getElementById('summaryStats');

            // Calculate success/failure counts
            let successCount = 0;
            let failureCount = 0;
            let unstableCount = 0;

            analysisResults.forEach(result => {
                const analysisLower = result.analysis.toLowerCase();
                if (analysisLower.includes('failure') || analysisLower.includes('failed')) {
                    failureCount++;
                } else if (analysisLower.includes('unstable') || analysisLower.includes('warning')) {
                    unstableCount++;
                } else {
                    successCount++;
                }
            });

            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${analyzedCount}</div>
                    <div class="stat-label">Jobs Analyzed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #4caf50;">${successCount}</div>
                    <div class="stat-label">Success</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #f44336;">${failureCount}</div>
                    <div class="stat-label">Failures</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ff9800;">${unstableCount}</div>
                    <div class="stat-label">Unstable</div>
                </div>
            `;

            // Update pipeline stages
            updatePipelineStages();
        }

        function updatePipelineStages() {
            const container = document.getElementById('stagesContainer');
            if (!container || analysisResults.length === 0) return;

            container.innerHTML = '';

            // Create stages for each job
            analysisResults.forEach((result, index) => {
                // Determine status
                const analysisLower = result.analysis.toLowerCase();
                let status = 'success';
                let icon = '‚úì';
                if (analysisLower.includes('failure') || analysisLower.includes('failed')) {
                    status = 'failure';
                    icon = '‚úó';
                } else if (analysisLower.includes('unstable') || analysisLower.includes('warning')) {
                    status = 'unstable';
                    icon = '‚ö†';
                }

                // Create stage box
                const stage = document.createElement('div');
                stage.className = `stage-box ${status}`;
                stage.innerHTML = `
                    <div class="stage-icon">${icon}</div>
                    <div class="stage-name">${result.job}</div>
                    <div class="stage-duration">Build #${result.build}</div>
                `;

                container.appendChild(stage);

                // Add arrow if not last item
                if (index < analysisResults.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'arrow';
                    container.appendChild(arrow);
                }
            });
        }

	        function escapeXml(unsafe) {
	            if (unsafe == null) return '';
	            return unsafe
	                .replace(/&/g, '&amp;')
	                .replace(/</g, '&lt;')
	                .replace(/>/g, '&gt;')
	                .replace(/"/g, '&quot;')
	                .replace(/'/g, '&apos;');
	        }

        function exportAsJSON() {
            if (analysisResults.length === 0) {
                alert('No analysis results to export');
                return;
            }
            const dataStr = JSON.stringify(analysisResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `jenkins-analysis-${new Date().toISOString().replace(/:/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

	        function exportAsXML() {
	            if (analysisResults.length === 0) {
	                alert('No analysis results to export');
	                return;
	            }

	            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<analysisResults>\n';
	            analysisResults.forEach((result) => {
	                xml += '  <jobResult>\n';
	                xml += `    <job>${escapeXml(result.job)}</job>\n`;
	                xml += `    <build>${escapeXml(String(result.build))}</build>\n`;
	                xml += `    <logSize>${result.log_size}</logSize>\n`;
	                xml += `    <timestamp>${escapeXml(result.timestamp)}</timestamp>\n`;
	                xml += `    <analysis>${escapeXml(result.analysis)}</analysis>\n`;
	                xml += '  </jobResult>\n';
	            });
	            xml += '</analysisResults>\n';

	            const dataBlob = new Blob([xml], {type: 'application/xml'});
	            const url = URL.createObjectURL(dataBlob);
	            const link = document.createElement('a');
	            link.href = url;
	            link.download = `jenkins-analysis-${new Date().toISOString().replace(/:/g, '-')}.xml`;
	            link.click();
	            URL.revokeObjectURL(url);
	        }
    </script>
</body>
</html>