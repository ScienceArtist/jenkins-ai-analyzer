<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jenkins Analysis Dashboard</title>
    <style>
        :root[data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --border-color-light: #e0e0e0;
            --accent-color: #667eea;
            --accent-hover: #5568d3;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --shadow: rgba(0,0,0,0.05);
            --card-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #242424;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --border-color-light: #353535;
            --accent-color: #7c8cff;
            --accent-hover: #6a7bef;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --shadow: rgba(0,0,0,0.3);
            --card-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            box-shadow: var(--card-shadow);
            z-index: 1000;
            transition: all 0.3s;
            color: var(--text-primary);
            font-weight: 500;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow);
            border-color: var(--accent-color);
        }

        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px var(--shadow);
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header .subtitle { opacity: 0.9; font-size: 1.1em; }
        .header .last-updated {
            margin-top: 15px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .header .nav-link {
            display: inline-block;
            margin-top: 15px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .header .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .controls {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            transition: background 0.3s;
        }
        .controls button {
            padding: 12px 24px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .controls button:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .controls select {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            margin-right: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--accent-color);
            transition: all 0.3s;
        }
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .pipeline-grid {
            display: grid;
            gap: 20px;
        }
        .pipeline-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: all 0.3s;
        }
        .pipeline-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }
        .pipeline-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pipeline-header h3 { font-size: 1.3em; }
        .pipeline-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }
        .pipeline-body {
            padding: 20px;
            display: none;
            background: var(--bg-secondary);
            transition: background 0.3s;
        }
        .pipeline-body.expanded { display: block; }

        /* Pipeline View Styles - 3 Column Layout */
        .status-columns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-column {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid var(--border-color);
        }
        .status-column.passed {
            border-top: 4px solid #10b981;
        }
        .status-column.failed {
            border-top: 4px solid #ef4444;
        }
        .status-column.unstable {
            border-top: 4px solid #f59e0b;
        }
        .column-header {
            font-weight: bold;
            font-size: 1.3em;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .column-header .count {
            background: var(--bg-tertiary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: auto;
        }
        .job-box {
            background: var(--bg-tertiary);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid #ccc;
            position: relative;
        }
        .job-box:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .status-column.passed .job-box {
            border-left-color: #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-tertiary) 100%);
        }
        .status-column.failed .job-box {
            border-left-color: #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-tertiary) 100%);
        }
        .status-column.unstable .job-box {
            border-left-color: #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-tertiary) 100%);
        }
        .job-box-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        .job-box-build {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .job-item {
            background: var(--bg-tertiary);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
            transition: background 0.3s;
        }
        .job-item .job-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .job-item .job-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .job-item .analysis {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .status-success { color: var(--success-color); }
        .status-error { color: var(--error-color); }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 1.2em;
        }

        /* AI Chat Assistant Styles */
        #chatWindow {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 600px;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 9999;
            border: 2px solid var(--accent-color);
        }
        #chatWindow.open {
            display: flex;
        }
        #chatHeader {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-height: 400px;
            background: var(--bg-tertiary);
        }
        .chat-message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
            max-width: 85%;
            word-wrap: break-word;
        }
        .chat-message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        .chat-message.assistant {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .chat-message.system {
            background: #f59e0b;
            color: white;
            text-align: center;
            font-size: 0.85em;
            max-width: 100%;
        }
        #chatInput {
            display: flex;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 0 0 10px 10px;
            gap: 10px;
        }
        #chatInput input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.95em;
        }
        #chatInput button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        #chatInput button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: var(--bg-secondary);
            color: var(--error-color);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid var(--error-color);
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Light Mode</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä Jenkins Analysis Dashboard</h1>
            <div class="subtitle">Multi-Pipeline Daily Analysis Results</div>
            <div class="last-updated" id="lastUpdated">Loading...</div>
            <a href="/" class="nav-link">üîç Go to Analyzer</a>
        </div>

        <div class="controls">
            <button onclick="refreshDashboard()">üîÑ Refresh Latest</button>
            <button onclick="showFilterModal()">üîç Filter Results</button>
            <button onclick="showNewFailures()">üî• New Failures</button>
            <button onclick="triggerDailyAnalysis()">‚ñ∂Ô∏è Run Analysis Now</button>
            <button onclick="exportResults()">üì• Export JSON</button>
            <button onclick="toggleChat()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">üí¨ AI Assistant</button>
        </div>

        <div id="filterControls" style="background: var(--bg-secondary); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: var(--card-shadow); display: none; transition: background 0.3s;">
            <h3 style="margin-top: 0; color: var(--text-primary);">üîç Filter Dashboard Results</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Date Range Filter -->
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: bold; margin-right: 10px; color: var(--text-primary);">Start Date:</label>
                        <input type="date" id="startDate" style="padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="font-weight: bold; margin-right: 10px; color: var(--text-primary);">End Date:</label>
                        <input type="date" id="endDate" style="padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                </div>

                <!-- Job Names Filter -->
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px; color: var(--text-primary);">
                        Job Names (comma-separated):
                        <span style="font-weight: normal; font-size: 0.9em; color: var(--text-secondary);">e.g., nightly, full-regression, upgrade-automatin</span>
                    </label>
                    <input type="text" id="jobNamesFilter" placeholder="Leave empty to show all jobs"
                           style="width: 100%; max-width: 600px; padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <!-- CalVer Build Filter -->
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px; color: var(--text-primary);">
                        Release Build (CalVer):
                        <span style="font-weight: normal; font-size: 0.9em; color: var(--text-secondary);">e.g., 2024.02.15, 2024.w07</span>
                    </label>
                    <input type="text" id="calverFilter" placeholder="Leave empty to show all builds"
                           style="width: 100%; max-width: 300px; padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <!-- Hide Empty Jobs -->
                <div>
                    <label style="font-weight: bold; color: var(--text-primary); cursor: pointer;">
                        <input type="checkbox" id="hideEmptyJobs" style="margin-right: 8px; cursor: pointer;">
                        Hide jobs with "No builds found"
                    </label>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="applyFilters()" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Apply Filters</button>
                    <button onclick="clearFilters()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear All</button>
                    <button onclick="hideFilters()" style="padding: 10px 20px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="label">Total Pipelines</div>
                <div class="value" id="totalPipelines">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Total Jobs Analyzed</div>
                <div class="value" id="totalJobs">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Passed Jobs</div>
                <div class="value" id="passedJobs" style="color: #10b981;">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Failed Jobs</div>
                <div class="value" id="failedJobs" style="color: #ef4444;">-</div>
            </div>
        </div>

        <div id="pipelineContainer" class="pipeline-grid">
            <div class="loading">Loading dashboard data...</div>
        </div>
    </div>

    <!-- AI Chat Assistant Window -->
    <div id="chatWindow">
        <div id="chatHeader">
            <span>üí¨ AI Dashboard Assistant</span>
            <button onclick="toggleChat()" style="background: transparent; border: none; color: white; font-size: 1.2em; cursor: pointer; padding: 0;">‚úï</button>
        </div>
        <div id="chatMessages">
            <div class="chat-message system">
                üëã Hi! I'm your AI assistant. Ask me about the dashboard, test results, or build statuses!
            </div>
        </div>
        <div id="chatInput">
            <input type="text" id="chatQuestion" placeholder="Ask a question..." onkeypress="if(event.key==='Enter') sendChatMessage()">
            <button onclick="sendChatMessage()" id="chatSendBtn">Send</button>
        </div>
    </div>

    <script>
        let currentData = null;

        // Load filters from URL on page load
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);

            // Check if there are filter parameters in URL
            const startDate = urlParams.get('start_date');
            const endDate = urlParams.get('end_date');
            const jobNames = urlParams.get('job_names');
            const calver = urlParams.get('calver');
            const hideEmpty = urlParams.get('hide_empty');

            if (startDate || endDate || jobNames || calver || hideEmpty) {
                // Apply filters from URL
                applyFiltersFromURL(urlParams);
            } else {
                // Load default dashboard
                refreshDashboard();
            }
        });

        async function applyFiltersFromURL(urlParams) {
            const startDate = urlParams.get('start_date');
            const endDate = urlParams.get('end_date');
            const jobNames = urlParams.get('job_names');
            const calver = urlParams.get('calver');
            const hideEmpty = urlParams.get('hide_empty');

            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading filtered results...</div>';

                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (jobNames) params.append('job_names', jobNames);
                if (calver) params.append('calver', calver);
                if (hideEmpty) params.append('hide_empty', hideEmpty);

                const response = await fetch(`/api/dashboard/filter?${params.toString()}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">${data.error}</div>`;
                    return;
                }

                currentData = data;
                renderFilteredResults(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        async function refreshDashboard() {
            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading...</div>';

                const response = await fetch('/api/dashboard/latest');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">No results available. Run daily analysis first.</div>`;
                    return;
                }

                currentData = data;
                renderDashboard(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error loading dashboard: ${error.message}</div>`;
            }
        }

        function showFilterModal() {
            document.getElementById('filterControls').style.display = 'block';
            // Set default dates (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);

            document.getElementById('endDate').valueAsDate = endDate;
            document.getElementById('startDate').valueAsDate = startDate;
        }

        function hideFilters() {
            document.getElementById('filterControls').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('jobNamesFilter').value = '';
            document.getElementById('calverFilter').value = '';
            document.getElementById('hideEmptyJobs').checked = false;
        }

        async function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const jobNames = document.getElementById('jobNamesFilter').value;
            const calver = document.getElementById('calverFilter').value;
            const hideEmpty = document.getElementById('hideEmptyJobs').checked;

            // If no filters applied, just refresh
            if (!startDate && !endDate && !jobNames && !calver && !hideEmpty) {
                alert('Please set at least one filter');
                return;
            }

            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading...</div>';
                hideFilters();

                // Build query parameters
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (jobNames) params.append('job_names', jobNames);
                if (calver) params.append('calver', calver);
                if (hideEmpty) params.append('hide_empty', 'true');

                // Update URL with filter parameters (shareable link!)
                window.history.pushState({}, '', `${window.location.pathname}?${params.toString()}`);

                const response = await fetch(`/api/dashboard/filter?${params.toString()}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">${data.error}</div>`;
                    return;
                }

                currentData = data;
                renderFilteredResults(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        // Keep old function for backward compatibility
        async function loadDateRange() {
            applyFilters();
        }

        async function showNewFailures() {
            const days = prompt('Show new failures from last how many days?', '7');
            if (!days) return;

            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading...</div>';

                const response = await fetch(`/api/dashboard/new-failures?days=${days}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">${data.error}</div>`;
                    return;
                }

                currentData = data;
                renderNewFailures(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        async function triggerDailyAnalysis() {
            if (!confirm('This will start a full analysis of all Jenkins jobs. This may take 30-60 minutes. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/run-daily-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                alert(`Analysis started! Task ID: ${data.task_id}\n\nThe analysis will run in the background. Refresh the dashboard in 30-60 minutes to see results.`);

                // Poll for status
                pollAnalysisStatus(data.task_id);

            } catch (error) {
                alert('Error starting analysis: ' + error.message);
            }
        }

        async function pollAnalysisStatus(taskId) {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'analysisStatus';
            statusDiv.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #667eea; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
            statusDiv.innerHTML = '‚è≥ Analysis running...';
            document.body.appendChild(statusDiv);

            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/daily-analysis-status/${taskId}`);
                    const data = await response.json();

                    if (data.status === 'complete') {
                        clearInterval(interval);
                        statusDiv.innerHTML = `‚úÖ Analysis complete! ${data.results.analyzed}/${data.results.total_jobs} jobs analyzed`;
                        setTimeout(() => {
                            statusDiv.remove();
                            refreshDashboard();
                        }, 3000);
                    } else if (data.status === 'error') {
                        clearInterval(interval);
                        statusDiv.innerHTML = '‚ùå Analysis failed: ' + data.error;
                        setTimeout(() => statusDiv.remove(), 5000);
                    } else {
                        statusDiv.innerHTML = '‚è≥ Analysis running...';
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 10000); // Poll every 10 seconds
        }

        function renderFilteredResults(data) {
            // Update header with filter info
            let headerText = 'Filtered Results';
            if (data.start_date && data.end_date) {
                headerText = `Date Range: ${data.start_date} to ${data.end_date}`;
            }
            if (data.job_names) {
                headerText += ` | Jobs: ${data.job_names}`;
            }
            if (data.calver) {
                headerText += ` | Build: ${data.calver}`;
            }
            document.getElementById('lastUpdated').textContent = headerText;

            // Calculate stats
            const results = data.results || [];
            const totalDays = results.length;
            const totalJobs = results.reduce((sum, day) => sum + day.total_jobs, 0);
            const totalPassed = results.reduce((sum, day) => sum + day.passed_jobs, 0);
            const totalFailed = results.reduce((sum, day) => sum + day.failed_jobs, 0);

            // Update stats
            document.getElementById('totalPipelines').textContent = totalDays;
            document.getElementById('totalJobs').textContent = totalJobs;
            document.getElementById('passedJobs').textContent = totalPassed;
            document.getElementById('failedJobs').textContent = totalFailed;

            // Render results by date
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No results found matching your filters.</div>';
                return;
            }

            // Render in 3-column layout
            renderThreeColumnView(results);
        }

        function renderThreeColumnView(results) {
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = ''; // Clear container first

            results.forEach((dayData, index) => {
                // Date header
                const dateHeader = document.createElement('h2');
                dateHeader.style.cssText = 'color: var(--text-primary); margin: 20px 0 15px 0;';
                dateHeader.textContent = `üìÖ ${dayData.date} (${dayData.total_jobs} jobs | ${dayData.passed_jobs} passed | ${dayData.failed_jobs} failed)`;
                container.appendChild(dateHeader);

                // Separate jobs by status
                const passedJobs = [];
                const failedJobs = [];
                const unstableJobs = [];

                dayData.jobs.forEach(job => {
                    if (job.status === 'passed') {
                        passedJobs.push(job);
                    } else if (job.failed_tests > 0) {
                        failedJobs.push(job);
                    } else {
                        unstableJobs.push(job);
                    }
                });

                // Create 3-column layout
                const columnsDiv = document.createElement('div');
                columnsDiv.className = 'status-columns';

                // Passed column
                const passedCol = document.createElement('div');
                passedCol.className = 'status-column passed';
                passedCol.innerHTML = `
                    <div class="column-header">
                        ‚úÖ Passed
                        <span class="count">${passedJobs.length}</span>
                    </div>
                `;
                passedJobs.forEach(job => {
                    const jobBox = createJobBox(job);
                    passedCol.appendChild(jobBox);
                });
                columnsDiv.appendChild(passedCol);

                // Failed column
                const failedCol = document.createElement('div');
                failedCol.className = 'status-column failed';
                failedCol.innerHTML = `
                    <div class="column-header">
                        ‚ùå Failed
                        <span class="count">${failedJobs.length}</span>
                    </div>
                `;
                failedJobs.forEach(job => {
                    const jobBox = createJobBox(job);
                    failedCol.appendChild(jobBox);
                });
                columnsDiv.appendChild(failedCol);

                // Unstable column
                const unstableCol = document.createElement('div');
                unstableCol.className = 'status-column unstable';
                unstableCol.innerHTML = `
                    <div class="column-header">
                        ‚ö†Ô∏è Unstable
                        <span class="count">${unstableJobs.length}</span>
                    </div>
                `;
                unstableJobs.forEach(job => {
                    const jobBox = createJobBox(job);
                    unstableCol.appendChild(jobBox);
                });
                columnsDiv.appendChild(unstableCol);

                container.appendChild(columnsDiv);
            });
        }

        function createJobBox(job) {
            const jobBox = document.createElement('div');
            jobBox.className = 'job-box';

            // Check if analysis is uncertain or rate-limited
            const analysisText = job.analysis_text || '';
            const uncertainKeywords = [
                'uncertain', 'unclear', 'unable to determine', 'cannot determine',
                'not visible', 'incomplete', 'partial information', 'unclear from',
                'manual investigation needed', 'additional information needed',
                'cannot be certain', 'not enough information',
                'RATE_LIMIT_STOP', 'rate limit reached', 'rate limit exceeded'
            ];
            const isUncertain = uncertainKeywords.some(keyword =>
                analysisText.toLowerCase().includes(keyword.toLowerCase())
            );

            const uncertainBadge = isUncertain ? '<div style="position: absolute; top: 5px; right: 5px; background: #f59e0b; color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; font-weight: bold;">?</div>' : '';

            jobBox.innerHTML = `
                ${uncertainBadge}
                <div class="job-box-name">${escapeHtml(job.job_name)}</div>
                <div class="job-box-build">Build #${job.build_number}</div>
            `;
            jobBox.onclick = () => showJobDetails(job);

            // Add visual indicator for uncertain jobs
            if (isUncertain) {
                jobBox.style.borderLeft = '4px solid #f59e0b';
            }

            return jobBox;
        }

        function showJobDetails(job) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

            const statusIcon = job.status === 'passed' ? '‚úÖ' : (job.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');

            // Check if analysis is uncertain or rate-limited (contains keywords indicating uncertainty)
            const analysisText = job.analysis_text || '';
            const uncertainKeywords = [
                'uncertain', 'unclear', 'unable to determine', 'cannot determine',
                'not visible', 'incomplete', 'partial information', 'unclear from',
                'manual investigation needed', 'additional information needed',
                'cannot be certain', 'not enough information',
                'RATE_LIMIT_STOP', 'rate limit reached', 'rate limit exceeded'
            ];
            const isUncertain = uncertainKeywords.some(keyword =>
                analysisText.toLowerCase().includes(keyword.toLowerCase())
            );

            const isRateLimited = analysisText.includes('RATE_LIMIT_STOP');
            const warningMessage = isRateLimited ?
                '‚ö†Ô∏è Rate limit hit - Re-analysis recommended' :
                '‚ö†Ô∏è Analysis uncertain - Re-analysis recommended';

            const reanalyzeButton = isUncertain ? `
                <button onclick="reanalyzeJob('${escapeHtml(job.job_name)}', ${job.build_number}, '${escapeHtml(job.jenkins_url || '')}', this)"
                        style="margin-top: 20px; margin-right: 10px; padding: 10px 20px; background: #f59e0b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    üîÑ Re-analyze (Deep)
                </button>
            ` : '';

            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 10px; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                    <h2 style="color: var(--text-primary); margin-top: 0;">${statusIcon} ${job.job_name} #${job.build_number}</h2>
                    <div style="color: var(--text-secondary); margin-bottom: 20px;">
                        Status: <strong>${job.status}</strong> |
                        Tests: ${job.passed_tests}/${job.total_tests} passed
                        ${job.failed_tests > 0 ? ` | <span style="color: #ef4444;">${job.failed_tests} failed</span>` : ''}
                        ${isUncertain ? `<br><span style="color: #f59e0b; font-weight: bold;">${warningMessage}</span>` : ''}
                    </div>
                    <div id="analysisContent" style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 0.9em; line-height: 1.6; color: var(--text-primary);">
                        ${escapeHtml(analysisText || 'No analysis available')}
                    </div>
                    <div style="margin-top: 20px;">
                        ${reanalyzeButton}
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Close</button>
                    </div>
                </div>
            `;

            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            document.body.appendChild(modal);
        }



        function renderDateRangeResults(data) {
            // Just use the new filtered results renderer
            renderFilteredResults(data);
        }

        // Legacy function kept for compatibility
        function renderDateRangeResultsOld(data) {
            // Update header
            document.getElementById('lastUpdated').textContent =
                `Date Range: ${data.start_date} to ${data.end_date}`;

            // Calculate stats
            const results = data.results || [];
            const totalDays = results.length;
            const totalJobs = results.reduce((sum, day) => sum + day.total_jobs, 0);
            const totalPassed = results.reduce((sum, day) => sum + day.passed_jobs, 0);
            const totalFailed = results.reduce((sum, day) => sum + day.failed_jobs, 0);

            // Update stats
            document.getElementById('totalPipelines').textContent = totalDays;
            document.getElementById('totalJobs').textContent = totalJobs;
            document.getElementById('successRate').textContent = totalPassed;
            document.getElementById('lastAnalysis').textContent = totalFailed;

            // Update stat labels
            document.querySelector('#totalPipelines').parentElement.querySelector('.label').textContent = 'Days Analyzed';
            document.querySelector('#successRate').parentElement.querySelector('.label').textContent = 'Passed Jobs';
            document.querySelector('#lastAnalysis').parentElement.querySelector('.label').textContent = 'Failed Jobs';

            // Render results by date
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No results found for this date range.</div>';
                return;
            }

            results.forEach((dayData, index) => {
                const card = document.createElement('div');
                card.className = 'pipeline-card';

                let bodyHTML = '';
                dayData.jobs.forEach(job => {
                    const statusIcon = job.status === 'passed' ? '‚úÖ' : (job.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');
                    bodyHTML += `
                        <div class="job-item">
                            <div class="job-title">${statusIcon} ${escapeHtml(job.job_name)} - Build #${job.build_number}</div>
                            <div class="job-meta">
                                Tests: ${job.passed_tests}/${job.total_tests} passed |
                                Log: ${(job.log_size / 1024).toFixed(1)} KB |
                                Model: ${job.model_used}
                            </div>
                            <div class="analysis">${escapeHtml(job.analysis_text || 'No analysis')}</div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="pipeline-header" onclick="togglePipeline(${index})">
                        <div>
                            <h3>üìÖ ${dayData.date}</h3>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">
                                ${dayData.passed_jobs} passed, ${dayData.failed_jobs} failed
                            </div>
                        </div>
                        <div class="badge">
                            ${dayData.total_jobs} jobs
                        </div>
                    </div>
                    <div class="pipeline-body" id="pipeline-${index}">
                        ${bodyHTML}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function renderNewFailures(data) {
            // Update header
            document.getElementById('lastUpdated').textContent =
                `New Failures in Last ${data.days} Days`;

            // Update stats
            document.getElementById('totalPipelines').textContent = data.count;
            document.getElementById('totalJobs').textContent = data.failures.length;

            const passedEl = document.getElementById('passedJobs');
            const failedEl = document.getElementById('failedJobs');
            if (passedEl) passedEl.textContent = '0';
            if (failedEl) failedEl.textContent = data.failures.length;

            // Update stat labels
            const labels = document.querySelectorAll('.stat-card .label');
            if (labels[0]) labels[0].textContent = 'New Failures';
            if (labels[1]) labels[1].textContent = 'Total Jobs';
            if (labels[2]) labels[2].textContent = 'Passed Jobs';
            if (labels[3]) labels[3].textContent = 'Failed Jobs';

            // Render failures
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            if (data.failures.length === 0) {
                container.innerHTML = '<div class="loading">üéâ No new failures found!</div>';
                return;
            }

            data.failures.forEach((failure, index) => {
                const card = document.createElement('div');
                card.className = 'pipeline-card';

                card.innerHTML = `
                    <div class="pipeline-header" onclick="togglePipeline(${index})">
                        <div>
                            <h3>‚ùå ${escapeHtml(failure.job_name)}</h3>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">
                                Build #${failure.build_number} | ${failure.failed_tests} failed tests
                            </div>
                        </div>
                        <div class="badge">
                            ${failure.date_key}
                        </div>
                    </div>
                    <div class="pipeline-body" id="pipeline-${index}">
                        <div class="job-item">
                            <div class="job-meta">
                                Tests: ${failure.passed_tests}/${failure.total_tests} passed |
                                Analyzed: ${new Date(failure.analyzed_at).toLocaleString()}
                            </div>
                            <div class="analysis">${escapeHtml(failure.analysis_text || 'No analysis')}</div>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        async function loadDateResults() {
            const date = document.getElementById('dateSelector').value;

            if (date === 'latest') {
                refreshDashboard();
                return;
            }

            try {
                const response = await fetch(`/api/dashboard/results?date=${date}`);
                const data = await response.json();

                if (data.error) {
                    alert('No results found for this date');
                    return;
                }

                currentData = data;
                renderDashboard(data);

            } catch (error) {
                alert('Error loading results: ' + error.message);
            }
        }

        async function populateDateSelector() {
            try {
                const response = await fetch('/api/dashboard/results');
                const data = await response.json();

                const selector = document.getElementById('dateSelector');
                selector.innerHTML = '<option value="latest">Latest Results</option>';

                data.results.forEach(result => {
                    const option = document.createElement('option');
                    option.value = result.date;
                    option.textContent = result.date;
                    selector.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading dates:', error);
            }
        }

        function renderDashboard(data) {
            // Update header
            document.getElementById('lastUpdated').textContent =
                `Last updated: ${data.date || 'N/A'}`;

            // Update stats from database-backed data
            const totalJobs = data.total_jobs || 0;
            const passedJobs = data.passed_jobs || 0;
            const failedJobs = data.failed_jobs || 0;

            document.getElementById('totalPipelines').textContent = '1';
            document.getElementById('totalJobs').textContent = totalJobs;

            // Update passedJobs and failedJobs if they exist
            const passedEl = document.getElementById('passedJobs');
            const failedEl = document.getElementById('failedJobs');
            if (passedEl) passedEl.textContent = passedJobs;
            if (failedEl) failedEl.textContent = failedJobs;

            // Fallback for old stat elements
            const successRateEl = document.getElementById('successRate');
            const lastAnalysisEl = document.getElementById('lastAnalysis');
            if (successRateEl) successRateEl.textContent = `${passedJobs}/${totalJobs}`;
            if (lastAnalysisEl) lastAnalysisEl.textContent = failedJobs;

            // Convert to format expected by renderFilteredResults
            const analyses = data.analyses || [];
            if (analyses.length === 0) {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">No analyses available yet. Run daily analysis first.</div>';
                return;
            }

            // Group analyses by date
            const byDate = {};
            analyses.forEach(analysis => {
                const dateKey = analysis.date_key || data.date || 'Unknown';
                if (!byDate[dateKey]) {
                    byDate[dateKey] = {
                        date: dateKey,
                        jobs: [],
                        total_jobs: 0,
                        passed_jobs: 0,
                        failed_jobs: 0
                    };
                }
                byDate[dateKey].jobs.push(analysis);
                byDate[dateKey].total_jobs++;
                if (analysis.status === 'passed') {
                    byDate[dateKey].passed_jobs++;
                } else if (analysis.failed_tests > 0) {
                    byDate[dateKey].failed_jobs++;
                }
            });

            // Use the same rendering logic as filtered results
            const formattedData = {
                results: Object.values(byDate)
            };

            // Render in 3-column layout
            renderThreeColumnView(formattedData.results);
        }

        function renderDashboardOld(data) {
            // Old rendering function kept for reference
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            const analyses = data.analyses || [];
            analyses.forEach((analysis, index) => {
                const card = document.createElement('div');
                card.className = 'pipeline-card';

                const statusIcon = analysis.status === 'passed' ? '‚úÖ' : (analysis.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');

                const bodyHTML = `
                    <div class="job-item">
                        <div class="job-title">${statusIcon} ${escapeHtml(analysis.job_name)} - Build #${analysis.build_number}</div>
                        <div class="job-meta">
                            Tests: ${analysis.passed_tests}/${analysis.total_tests} passed |
                            Log: ${(analysis.log_size / 1024).toFixed(1)} KB |
                            Type: ${analysis.log_type} |
                            Model: ${analysis.model_used}
                        </div>
                        <div class="analysis">${escapeHtml(analysis.analysis_text || 'No analysis available')}</div>
                    </div>
                `;

                card.innerHTML = `
                    <div class="pipeline-header" onclick="togglePipeline(${index})">
                        <div>
                            <h3>${statusIcon} ${escapeHtml(analysis.job_name)}</h3>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">
                                ${analysis.jenkins_url || ''} | ${new Date(analysis.analyzed_at).toLocaleString()}
                            </div>
                        </div>
                        <div class="badge">
                            Build #${analysis.build_number}
                        </div>
                    </div>
                    <div class="pipeline-body" id="pipeline-${index}">
                        ${bodyHTML}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function togglePipeline(index) {
            const body = document.getElementById(`pipeline-${index}`);
            body.classList.toggle('expanded');
        }

        function exportResults() {
            if (!currentData) {
                alert('No data to export');
                return;
            }

            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `jenkins-dashboard-${currentData.date}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        async function reanalyzeJob(jobName, buildNumber, jenkinsUrl, buttonElement) {
            if (!confirm(`Re-analyze ${jobName} #${buildNumber}?\n\nThis will perform a deep analysis using console logs + debug logs (if available) and may take 1-2 minutes.`)) {
                return;
            }

            // Disable button and show loading
            buttonElement.disabled = true;
            buttonElement.innerHTML = '‚è≥ Re-analyzing...';

            const analysisContent = document.getElementById('analysisContent');
            const originalContent = analysisContent.innerHTML;
            analysisContent.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">‚è≥ Performing deep analysis...<br>Gathering console logs + debug logs...<br>This may take 1-2 minutes...</div>';

            try {
                const response = await fetch('/api/reanalyze-job', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        job_name: jobName,
                        build_number: buildNumber,
                        jenkins_url: jenkinsUrl || window.location.origin.replace(':5000', '')
                    })
                });

                const data = await response.json();

                if (data.error) {
                    analysisContent.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${escapeHtml(data.error)}</div>`;
                    buttonElement.disabled = false;
                    buttonElement.innerHTML = 'üîÑ Re-analyze (Deep)';
                    return;
                }

                // Update with new analysis
                const logSources = data.log_sources.join(' + ');
                analysisContent.innerHTML = `
                    <div style="background: #10b981; color: white; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-weight: bold;">
                        ‚úÖ Re-analysis complete! (Sources: ${logSources} | Size: ${(data.log_size / 1024).toFixed(1)} KB)
                    </div>
                    ${escapeHtml(data.analysis)}
                `;

                // Remove re-analyze button (analysis is now complete)
                buttonElement.remove();

                // Refresh dashboard in background to update the main view
                setTimeout(() => {
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.has('start_date') || urlParams.has('end_date') || urlParams.has('job_names') || urlParams.has('calver') || urlParams.has('hide_empty')) {
                        applyFiltersFromURL(urlParams);
                    } else {
                        refreshDashboard();
                    }
                }, 2000);

            } catch (error) {
                analysisContent.innerHTML = `<div style="color: #ef4444;">‚ùå Error: ${escapeHtml(error.message)}</div>`;
                buttonElement.disabled = false;
                buttonElement.innerHTML = 'üîÑ Re-analyze (Deep)';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // AI Chat Assistant Functions
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('open');

            // Focus input when opening
            if (chatWindow.classList.contains('open')) {
                document.getElementById('chatQuestion').focus();
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatQuestion');
            const question = input.value.trim();

            if (!question) return;

            // Add user message to chat
            const messagesDiv = document.getElementById('chatMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = question;
            messagesDiv.appendChild(userMsg);

            // Clear input
            input.value = '';

            // Disable send button
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '...';

            // Add thinking message
            const thinkingMsg = document.createElement('div');
            thinkingMsg.className = 'chat-message assistant';
            thinkingMsg.textContent = 'ü§î Thinking...';
            messagesDiv.appendChild(thinkingMsg);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                // Prepare dashboard context
                const dashboardData = {
                    total_jobs: parseInt(document.getElementById('totalJobs')?.textContent || '0'),
                    passed_jobs: parseInt(document.getElementById('passedJobs')?.textContent || '0'),
                    failed_jobs: parseInt(document.getElementById('failedJobs')?.textContent || '0'),
                    unstable_jobs: 0, // Calculate if needed
                    date: document.getElementById('lastUpdated')?.textContent || 'unknown'
                };

                const response = await fetch('/api/dashboard-chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        question: question,
                        dashboard_data: dashboardData
                    })
                });

                const data = await response.json();

                // Remove thinking message
                thinkingMsg.remove();

                if (data.error) {
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'chat-message system';
                    errorMsg.textContent = '‚ùå ' + data.error;
                    messagesDiv.appendChild(errorMsg);
                } else {
                    const assistantMsg = document.createElement('div');
                    assistantMsg.className = 'chat-message assistant';
                    assistantMsg.textContent = data.answer;
                    messagesDiv.appendChild(assistantMsg);
                }

            } catch (error) {
                thinkingMsg.remove();
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message system';
                errorMsg.textContent = '‚ùå Error: ' + error.message;
                messagesDiv.appendChild(errorMsg);
            }

            // Re-enable send button
            sendBtn.disabled = false;
            sendBtn.textContent = 'Send';

            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update toggle button
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');

            if (newTheme === 'dark') {
                icon.textContent = 'üåô';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Dark Mode';
            }
        }

        // Initialize theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');

            if (savedTheme === 'dark') {
                icon.textContent = 'üåô';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Dark Mode';
            }
        })();

        // Auto-refresh every 5 minutes (respects URL filters)
        setInterval(() => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('start_date') || urlParams.has('end_date') || urlParams.has('job_names') || urlParams.has('calver') || urlParams.has('hide_empty')) {
                // Re-apply filters from URL
                applyFiltersFromURL(urlParams);
            } else {
                // Refresh default dashboard
                refreshDashboard();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>

