<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jenkins Analysis Dashboard</title>
    <style>
        :root[data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: white;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --border-color-light: #e0e0e0;
            --accent-color: #667eea;
            --accent-hover: #5568d3;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --shadow: rgba(0,0,0,0.05);
            --card-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #242424;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --border-color-light: #353535;
            --accent-color: #7c8cff;
            --accent-hover: #6a7bef;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --shadow: rgba(0,0,0,0.3);
            --card-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            box-shadow: var(--card-shadow);
            z-index: 1000;
            transition: all 0.3s;
            color: var(--text-primary);
            font-weight: 500;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow);
            border-color: var(--accent-color);
        }

        .container { max-width: 1400px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px var(--shadow);
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header .subtitle { opacity: 0.9; font-size: 1.1em; }
        .header .last-updated {
            margin-top: 15px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .header .nav-link {
            display: inline-block;
            margin-top: 15px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .header .nav-link:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .controls {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            transition: background 0.3s;
        }
        .controls button {
            padding: 12px 24px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
            transition: all 0.2s;
        }
        .controls button:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .controls select {
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            margin-right: 10px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--accent-color);
            transition: all 0.3s;
        }
        .stat-card .label {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--text-primary);
        }

        .pipeline-grid {
            display: grid;
            gap: 20px;
        }
        .pipeline-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            transition: all 0.3s;
        }
        .pipeline-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }
        .pipeline-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pipeline-header h3 { font-size: 1.3em; }
        .pipeline-header .badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
        }
        .pipeline-body {
            padding: 20px;
            display: none;
            background: var(--bg-secondary);
            transition: background 0.3s;
        }
        .pipeline-body.expanded { display: block; }

        /* Pipeline View Styles */
        .pipeline-flow {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .pipeline-stage {
            min-width: 200px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }
        .pipeline-stage:hover {
            border-color: var(--accent-color);
            box-shadow: 0 4px 12px var(--shadow);
        }
        .stage-header {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stage-job {
            background: var(--bg-secondary);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }
        .stage-job:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px var(--shadow);
        }
        .stage-job.passed {
            border-left-color: #10b981;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, var(--bg-secondary) 100%);
        }
        .stage-job.failed {
            border-left-color: #ef4444;
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, var(--bg-secondary) 100%);
        }
        .stage-job.unstable {
            border-left-color: #f59e0b;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.1) 0%, var(--bg-secondary) 100%);
        }
        .stage-job-name {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        .stage-job-build {
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .stage-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 30px;
            color: var(--text-secondary);
            font-size: 1.5em;
        }

        .job-item {
            background: var(--bg-tertiary);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
            transition: background 0.3s;
        }
        .job-item .job-title {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .job-item .job-meta {
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        .job-item .analysis {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .status-success { color: var(--success-color); }
        .status-error { color: var(--error-color); }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-size: 1.2em;
        }
        .error-message {
            background: var(--bg-secondary);
            color: var(--error-color);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid var(--error-color);
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Light Mode</span>
    </div>

    <div class="container">
        <div class="header">
            <h1>üìä Jenkins Analysis Dashboard</h1>
            <div class="subtitle">Multi-Pipeline Daily Analysis Results</div>
            <div class="last-updated" id="lastUpdated">Loading...</div>
            <a href="/" class="nav-link">üîç Go to Analyzer</a>
        </div>

        <div class="controls">
            <button onclick="refreshDashboard()">üîÑ Refresh Latest</button>
            <button onclick="showFilterModal()">üîç Filter Results</button>
            <button onclick="showNewFailures()">üî• New Failures</button>
            <button onclick="triggerDailyAnalysis()">‚ñ∂Ô∏è Run Analysis Now</button>
            <button onclick="exportResults()">üì• Export JSON</button>
            <div style="display: inline-block; margin-left: 20px;">
                <label style="color: var(--text-primary); font-weight: bold;">View:</label>
                <select id="viewMode" onchange="changeViewMode()" style="padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); cursor: pointer; margin-left: 5px;">
                    <option value="pipeline">üîÄ Pipeline View</option>
                    <option value="list">üìã List View</option>
                </select>
            </div>
        </div>

        <div id="filterControls" style="background: var(--bg-secondary); padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: var(--card-shadow); display: none; transition: background 0.3s;">
            <h3 style="margin-top: 0; color: var(--text-primary);">üîç Filter Dashboard Results</h3>
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Date Range Filter -->
                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                    <div>
                        <label style="font-weight: bold; margin-right: 10px; color: var(--text-primary);">Start Date:</label>
                        <input type="date" id="startDate" style="padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                    <div>
                        <label style="font-weight: bold; margin-right: 10px; color: var(--text-primary);">End Date:</label>
                        <input type="date" id="endDate" style="padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                    </div>
                </div>

                <!-- Job Names Filter -->
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px; color: var(--text-primary);">
                        Job Names (comma-separated):
                        <span style="font-weight: normal; font-size: 0.9em; color: var(--text-secondary);">e.g., nightly, full-regression, upgrade-automatin</span>
                    </label>
                    <input type="text" id="jobNamesFilter" placeholder="Leave empty to show all jobs"
                           style="width: 100%; max-width: 600px; padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <!-- CalVer Build Filter -->
                <div>
                    <label style="font-weight: bold; display: block; margin-bottom: 5px; color: var(--text-primary);">
                        Release Build (CalVer):
                        <span style="font-weight: normal; font-size: 0.9em; color: var(--text-secondary);">e.g., 2024.02.15, 2024.w07</span>
                    </label>
                    <input type="text" id="calverFilter" placeholder="Leave empty to show all builds"
                           style="width: 100%; max-width: 300px; padding: 8px; border: 2px solid var(--border-color); border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary);">
                </div>

                <!-- Hide Empty Jobs -->
                <div>
                    <label style="font-weight: bold; color: var(--text-primary); cursor: pointer;">
                        <input type="checkbox" id="hideEmptyJobs" style="margin-right: 8px; cursor: pointer;">
                        Hide jobs with "No builds found"
                    </label>
                </div>

                <!-- Action Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button onclick="applyFilters()" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Apply Filters</button>
                    <button onclick="clearFilters()" style="padding: 10px 20px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear All</button>
                    <button onclick="hideFilters()" style="padding: 10px 20px; background: #999; color: white; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                </div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="label">Total Pipelines</div>
                <div class="value" id="totalPipelines">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Total Jobs Analyzed</div>
                <div class="value" id="totalJobs">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Passed Jobs</div>
                <div class="value" id="passedJobs" style="color: #10b981;">-</div>
            </div>
            <div class="stat-card">
                <div class="label">Failed Jobs</div>
                <div class="value" id="failedJobs" style="color: #ef4444;">-</div>
            </div>
        </div>

        <div id="pipelineContainer" class="pipeline-grid">
            <div class="loading">Loading dashboard data...</div>
        </div>
    </div>

    <script>
        let currentData = null;
        let currentViewMode = 'pipeline';

        // Load filters from URL on page load
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);

            // Load view mode from URL or localStorage
            const viewMode = urlParams.get('view') || localStorage.getItem('dashboardViewMode') || 'pipeline';
            currentViewMode = viewMode;
            document.getElementById('viewMode').value = viewMode;

            // Check if there are filter parameters in URL
            const startDate = urlParams.get('start_date');
            const endDate = urlParams.get('end_date');
            const jobNames = urlParams.get('job_names');
            const calver = urlParams.get('calver');
            const hideEmpty = urlParams.get('hide_empty');

            if (startDate || endDate || jobNames || calver || hideEmpty) {
                // Apply filters from URL
                applyFiltersFromURL(urlParams);
            } else {
                // Load default dashboard
                refreshDashboard();
            }
        });

        function changeViewMode() {
            currentViewMode = document.getElementById('viewMode').value;
            localStorage.setItem('dashboardViewMode', currentViewMode);

            // Update URL with view parameter
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('view', currentViewMode);
            window.history.replaceState({}, '', `${window.location.pathname}?${urlParams.toString()}`);

            // Re-render current data with new view
            if (currentData) {
                if (currentData.results) {
                    renderFilteredResults(currentData);
                } else {
                    renderDashboard(currentData);
                }
            }
        }

        async function applyFiltersFromURL(urlParams) {
            const startDate = urlParams.get('start_date');
            const endDate = urlParams.get('end_date');
            const jobNames = urlParams.get('job_names');
            const calver = urlParams.get('calver');
            const hideEmpty = urlParams.get('hide_empty');

            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading filtered results...</div>';

                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (jobNames) params.append('job_names', jobNames);
                if (calver) params.append('calver', calver);
                if (hideEmpty) params.append('hide_empty', hideEmpty);

                const response = await fetch(`/api/dashboard/filter?${params.toString()}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">${data.error}</div>`;
                    return;
                }

                currentData = data;
                renderFilteredResults(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        async function refreshDashboard() {
            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading...</div>';

                const response = await fetch('/api/dashboard/latest');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">No results available. Run daily analysis first.</div>`;
                    return;
                }

                currentData = data;
                renderDashboard(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error loading dashboard: ${error.message}</div>`;
            }
        }

        function showFilterModal() {
            document.getElementById('filterControls').style.display = 'block';
            // Set default dates (last 7 days)
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);

            document.getElementById('endDate').valueAsDate = endDate;
            document.getElementById('startDate').valueAsDate = startDate;
        }

        function hideFilters() {
            document.getElementById('filterControls').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('jobNamesFilter').value = '';
            document.getElementById('calverFilter').value = '';
            document.getElementById('hideEmptyJobs').checked = false;
        }

        async function applyFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const jobNames = document.getElementById('jobNamesFilter').value;
            const calver = document.getElementById('calverFilter').value;
            const hideEmpty = document.getElementById('hideEmptyJobs').checked;

            // If no filters applied, just refresh
            if (!startDate && !endDate && !jobNames && !calver && !hideEmpty) {
                alert('Please set at least one filter');
                return;
            }

            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading...</div>';
                hideFilters();

                // Build query parameters
                const params = new URLSearchParams();
                if (startDate) params.append('start_date', startDate);
                if (endDate) params.append('end_date', endDate);
                if (jobNames) params.append('job_names', jobNames);
                if (calver) params.append('calver', calver);
                if (hideEmpty) params.append('hide_empty', 'true');
                params.append('view', currentViewMode);

                // Update URL with filter parameters (shareable link!)
                window.history.pushState({}, '', `${window.location.pathname}?${params.toString()}`);

                const response = await fetch(`/api/dashboard/filter?${params.toString()}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">${data.error}</div>`;
                    return;
                }

                currentData = data;
                renderFilteredResults(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        // Keep old function for backward compatibility
        async function loadDateRange() {
            applyFilters();
        }

        async function showNewFailures() {
            const days = prompt('Show new failures from last how many days?', '7');
            if (!days) return;

            try {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">Loading...</div>';

                const response = await fetch(`/api/dashboard/new-failures?days=${days}`);
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pipelineContainer').innerHTML =
                        `<div class="error-message">${data.error}</div>`;
                    return;
                }

                currentData = data;
                renderNewFailures(data);

            } catch (error) {
                document.getElementById('pipelineContainer').innerHTML =
                    `<div class="error-message">Error: ${error.message}</div>`;
            }
        }

        async function triggerDailyAnalysis() {
            if (!confirm('This will start a full analysis of all Jenkins jobs. This may take 30-60 minutes. Continue?')) {
                return;
            }

            try {
                const response = await fetch('/api/run-daily-analysis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                alert(`Analysis started! Task ID: ${data.task_id}\n\nThe analysis will run in the background. Refresh the dashboard in 30-60 minutes to see results.`);

                // Poll for status
                pollAnalysisStatus(data.task_id);

            } catch (error) {
                alert('Error starting analysis: ' + error.message);
            }
        }

        async function pollAnalysisStatus(taskId) {
            const statusDiv = document.createElement('div');
            statusDiv.id = 'analysisStatus';
            statusDiv.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #667eea; color: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000;';
            statusDiv.innerHTML = '‚è≥ Analysis running...';
            document.body.appendChild(statusDiv);

            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/daily-analysis-status/${taskId}`);
                    const data = await response.json();

                    if (data.status === 'complete') {
                        clearInterval(interval);
                        statusDiv.innerHTML = `‚úÖ Analysis complete! ${data.results.analyzed}/${data.results.total_jobs} jobs analyzed`;
                        setTimeout(() => {
                            statusDiv.remove();
                            refreshDashboard();
                        }, 3000);
                    } else if (data.status === 'error') {
                        clearInterval(interval);
                        statusDiv.innerHTML = '‚ùå Analysis failed: ' + data.error;
                        setTimeout(() => statusDiv.remove(), 5000);
                    } else {
                        statusDiv.innerHTML = '‚è≥ Analysis running...';
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                }
            }, 10000); // Poll every 10 seconds
        }

        function renderFilteredResults(data) {
            // Update header with filter info
            let headerText = 'Filtered Results';
            if (data.start_date && data.end_date) {
                headerText = `Date Range: ${data.start_date} to ${data.end_date}`;
            }
            if (data.job_names) {
                headerText += ` | Jobs: ${data.job_names}`;
            }
            if (data.calver) {
                headerText += ` | Build: ${data.calver}`;
            }
            document.getElementById('lastUpdated').textContent = headerText;

            // Calculate stats
            const results = data.results || [];
            const totalDays = results.length;
            const totalJobs = results.reduce((sum, day) => sum + day.total_jobs, 0);
            const totalPassed = results.reduce((sum, day) => sum + day.passed_jobs, 0);
            const totalFailed = results.reduce((sum, day) => sum + day.failed_jobs, 0);

            // Update stats
            document.getElementById('totalPipelines').textContent = totalDays;
            document.getElementById('totalJobs').textContent = totalJobs;
            document.getElementById('passedJobs').textContent = totalPassed;
            document.getElementById('failedJobs').textContent = totalFailed;

            // Render results by date
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No results found matching your filters.</div>';
                return;
            }

            // Render based on view mode
            if (currentViewMode === 'pipeline') {
                renderPipelineView(results);
            } else {
                renderListView(results);
            }
        }

        function renderPipelineView(results) {
            const container = document.getElementById('pipelineContainer');

            results.forEach((dayData, index) => {
                // Group jobs by common prefixes (stages)
                const stages = groupJobsByStage(dayData.jobs);

                const dateHeader = document.createElement('h2');
                dateHeader.style.cssText = 'color: var(--text-primary); margin: 20px 0 10px 0;';
                dateHeader.textContent = `üìÖ ${dayData.date} (${dayData.total_jobs} jobs | ${dayData.passed_jobs} passed | ${dayData.failed_jobs} failed)`;
                container.appendChild(dateHeader);

                const pipelineFlow = document.createElement('div');
                pipelineFlow.className = 'pipeline-flow';

                const stageNames = Object.keys(stages);
                stageNames.forEach((stageName, idx) => {
                    const stageDiv = document.createElement('div');
                    stageDiv.className = 'pipeline-stage';

                    const stageHeader = document.createElement('div');
                    stageHeader.className = 'stage-header';
                    stageHeader.innerHTML = `üîπ ${stageName}`;
                    stageDiv.appendChild(stageHeader);

                    stages[stageName].forEach(job => {
                        const jobDiv = document.createElement('div');
                        const statusClass = job.status === 'passed' ? 'passed' : (job.failed_tests > 0 ? 'failed' : 'unstable');
                        const statusIcon = job.status === 'passed' ? '‚úÖ' : (job.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');

                        jobDiv.className = `stage-job ${statusClass}`;
                        jobDiv.innerHTML = `
                            <div class="stage-job-name">${statusIcon} ${job.job_name}</div>
                            <div class="stage-job-build">#${job.build_number}</div>
                        `;
                        jobDiv.onclick = () => showJobDetails(job);
                        stageDiv.appendChild(jobDiv);
                    });

                    pipelineFlow.appendChild(stageDiv);

                    // Add connector arrow between stages
                    if (idx < stageNames.length - 1) {
                        const connector = document.createElement('div');
                        connector.className = 'stage-connector';
                        connector.innerHTML = '‚Üí';
                        pipelineFlow.appendChild(connector);
                    }
                });

                container.appendChild(pipelineFlow);
            });
        }

        function groupJobsByStage(jobs) {
            const stages = {};

            jobs.forEach(job => {
                const jobName = job.job_name;
                let stageName = 'Other';

                // Try to extract stage from job name
                if (jobName.includes('nightly')) {
                    stageName = 'Nightly';
                } else if (jobName.includes('regression')) {
                    stageName = 'Regression';
                } else if (jobName.includes('upgrade')) {
                    stageName = 'Upgrade';
                } else if (jobName.includes('virtual')) {
                    stageName = 'Virtual';
                } else if (jobName.includes('automatin')) {
                    stageName = 'Automatin';
                } else {
                    // Use first part of job name as stage
                    const parts = jobName.split('-');
                    if (parts.length > 1) {
                        stageName = parts[0].charAt(0).toUpperCase() + parts[0].slice(1);
                    }
                }

                if (!stages[stageName]) {
                    stages[stageName] = [];
                }
                stages[stageName].push(job);
            });

            return stages;
        }

        function showJobDetails(job) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';

            const statusIcon = job.status === 'passed' ? '‚úÖ' : (job.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');

            modal.innerHTML = `
                <div style="background: var(--bg-secondary); border-radius: 10px; max-width: 800px; max-height: 90vh; overflow-y: auto; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                    <h2 style="color: var(--text-primary); margin-top: 0;">${statusIcon} ${job.job_name} #${job.build_number}</h2>
                    <div style="color: var(--text-secondary); margin-bottom: 20px;">
                        Status: <strong>${job.status}</strong> |
                        Tests: ${job.passed_tests}/${job.total_tests} passed
                        ${job.failed_tests > 0 ? ` | <span style="color: #ef4444;">${job.failed_tests} failed</span>` : ''}
                    </div>
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; white-space: pre-wrap; font-family: monospace; font-size: 0.9em; line-height: 1.6; color: var(--text-primary);">
                        ${escapeHtml(job.analysis_text || 'No analysis available')}
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 20px; padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Close</button>
                </div>
            `;

            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };

            document.body.appendChild(modal);
        }

        function renderListView(results) {
            const container = document.getElementById('pipelineContainer');

            results.forEach((dayData, index) => {
                const card = document.createElement('div');
                card.className = 'pipeline-card';

                let bodyHTML = '';
                dayData.jobs.forEach(job => {
                    const statusIcon = job.status === 'passed' ? '‚úÖ' : (job.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');
                    bodyHTML += `
                        <div class="job-item">
                            <div class="job-header">
                                <span class="job-name">${statusIcon} ${job.job_name} #${job.build_number}</span>
                                <span class="job-status ${job.status}">${job.status}</span>
                            </div>
                            ${job.failed_tests > 0 ? `
                                <div class="test-summary">
                                    ‚ùå ${job.failed_tests} failed | ‚úÖ ${job.passed_tests} passed | üìä ${job.total_tests} total
                                </div>
                            ` : ''}
                            <div class="analysis-section">
                                <div class="analysis-text">${job.analysis_text || 'No analysis available'}</div>
                            </div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="pipeline-header">
                        <div class="pipeline-name">üìÖ ${dayData.date}</div>
                        <div class="pipeline-status">
                            ${dayData.total_jobs} jobs | ${dayData.passed_jobs} passed | ${dayData.failed_jobs} failed
                        </div>
                    </div>
                    <div class="pipeline-body">
                        ${bodyHTML}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function renderDateRangeResults(data) {
            // Just use the new filtered results renderer
            renderFilteredResults(data);
        }

        // Legacy function kept for compatibility
        function renderDateRangeResultsOld(data) {
            // Update header
            document.getElementById('lastUpdated').textContent =
                `Date Range: ${data.start_date} to ${data.end_date}`;

            // Calculate stats
            const results = data.results || [];
            const totalDays = results.length;
            const totalJobs = results.reduce((sum, day) => sum + day.total_jobs, 0);
            const totalPassed = results.reduce((sum, day) => sum + day.passed_jobs, 0);
            const totalFailed = results.reduce((sum, day) => sum + day.failed_jobs, 0);

            // Update stats
            document.getElementById('totalPipelines').textContent = totalDays;
            document.getElementById('totalJobs').textContent = totalJobs;
            document.getElementById('successRate').textContent = totalPassed;
            document.getElementById('lastAnalysis').textContent = totalFailed;

            // Update stat labels
            document.querySelector('#totalPipelines').parentElement.querySelector('.label').textContent = 'Days Analyzed';
            document.querySelector('#successRate').parentElement.querySelector('.label').textContent = 'Passed Jobs';
            document.querySelector('#lastAnalysis').parentElement.querySelector('.label').textContent = 'Failed Jobs';

            // Render results by date
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            if (results.length === 0) {
                container.innerHTML = '<div class="loading">No results found for this date range.</div>';
                return;
            }

            results.forEach((dayData, index) => {
                const card = document.createElement('div');
                card.className = 'pipeline-card';

                let bodyHTML = '';
                dayData.jobs.forEach(job => {
                    const statusIcon = job.status === 'passed' ? '‚úÖ' : (job.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');
                    bodyHTML += `
                        <div class="job-item">
                            <div class="job-title">${statusIcon} ${escapeHtml(job.job_name)} - Build #${job.build_number}</div>
                            <div class="job-meta">
                                Tests: ${job.passed_tests}/${job.total_tests} passed |
                                Log: ${(job.log_size / 1024).toFixed(1)} KB |
                                Model: ${job.model_used}
                            </div>
                            <div class="analysis">${escapeHtml(job.analysis_text || 'No analysis')}</div>
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="pipeline-header" onclick="togglePipeline(${index})">
                        <div>
                            <h3>üìÖ ${dayData.date}</h3>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">
                                ${dayData.passed_jobs} passed, ${dayData.failed_jobs} failed
                            </div>
                        </div>
                        <div class="badge">
                            ${dayData.total_jobs} jobs
                        </div>
                    </div>
                    <div class="pipeline-body" id="pipeline-${index}">
                        ${bodyHTML}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function renderNewFailures(data) {
            // Update header
            document.getElementById('lastUpdated').textContent =
                `New Failures in Last ${data.days} Days`;

            // Update stats
            document.getElementById('totalPipelines').textContent = data.count;
            document.getElementById('totalJobs').textContent = data.failures.length;
            document.getElementById('successRate').textContent = data.days;
            document.getElementById('lastAnalysis').textContent = '-';

            // Update stat labels
            document.querySelector('#totalPipelines').parentElement.querySelector('.label').textContent = 'New Failures';
            document.querySelector('#totalJobs').parentElement.querySelector('.label').textContent = 'Total Jobs';
            document.querySelector('#successRate').parentElement.querySelector('.label').textContent = 'Days Analyzed';

            // Render failures
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            if (data.failures.length === 0) {
                container.innerHTML = '<div class="loading">üéâ No new failures found!</div>';
                return;
            }

            data.failures.forEach((failure, index) => {
                const card = document.createElement('div');
                card.className = 'pipeline-card';

                card.innerHTML = `
                    <div class="pipeline-header" onclick="togglePipeline(${index})">
                        <div>
                            <h3>‚ùå ${escapeHtml(failure.job_name)}</h3>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">
                                Build #${failure.build_number} | ${failure.failed_tests} failed tests
                            </div>
                        </div>
                        <div class="badge">
                            ${failure.date_key}
                        </div>
                    </div>
                    <div class="pipeline-body" id="pipeline-${index}">
                        <div class="job-item">
                            <div class="job-meta">
                                Tests: ${failure.passed_tests}/${failure.total_tests} passed |
                                Analyzed: ${new Date(failure.analyzed_at).toLocaleString()}
                            </div>
                            <div class="analysis">${escapeHtml(failure.analysis_text || 'No analysis')}</div>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        async function loadDateResults() {
            const date = document.getElementById('dateSelector').value;

            if (date === 'latest') {
                refreshDashboard();
                return;
            }

            try {
                const response = await fetch(`/api/dashboard/results?date=${date}`);
                const data = await response.json();

                if (data.error) {
                    alert('No results found for this date');
                    return;
                }

                currentData = data;
                renderDashboard(data);

            } catch (error) {
                alert('Error loading results: ' + error.message);
            }
        }

        async function populateDateSelector() {
            try {
                const response = await fetch('/api/dashboard/results');
                const data = await response.json();

                const selector = document.getElementById('dateSelector');
                selector.innerHTML = '<option value="latest">Latest Results</option>';

                data.results.forEach(result => {
                    const option = document.createElement('option');
                    option.value = result.date;
                    option.textContent = result.date;
                    selector.appendChild(option);
                });

            } catch (error) {
                console.error('Error loading dates:', error);
            }
        }

        function renderDashboard(data) {
            // Update header
            document.getElementById('lastUpdated').textContent =
                `Last updated: ${data.date || 'N/A'}`;

            // Update stats from database-backed data
            const totalJobs = data.total_jobs || 0;
            const passedJobs = data.passed_jobs || 0;
            const failedJobs = data.failed_jobs || 0;

            document.getElementById('totalPipelines').textContent = '1';
            document.getElementById('totalJobs').textContent = totalJobs;

            // Update passedJobs and failedJobs if they exist
            const passedEl = document.getElementById('passedJobs');
            const failedEl = document.getElementById('failedJobs');
            if (passedEl) passedEl.textContent = passedJobs;
            if (failedEl) failedEl.textContent = failedJobs;

            // Fallback for old stat elements
            const successRateEl = document.getElementById('successRate');
            const lastAnalysisEl = document.getElementById('lastAnalysis');
            if (successRateEl) successRateEl.textContent = `${passedJobs}/${totalJobs}`;
            if (lastAnalysisEl) lastAnalysisEl.textContent = failedJobs;

            // Convert to format expected by renderFilteredResults
            const analyses = data.analyses || [];
            if (analyses.length === 0) {
                document.getElementById('pipelineContainer').innerHTML = '<div class="loading">No analyses available yet. Run daily analysis first.</div>';
                return;
            }

            // Group analyses by date
            const byDate = {};
            analyses.forEach(analysis => {
                const dateKey = analysis.date_key || data.date || 'Unknown';
                if (!byDate[dateKey]) {
                    byDate[dateKey] = {
                        date: dateKey,
                        jobs: [],
                        total_jobs: 0,
                        passed_jobs: 0,
                        failed_jobs: 0
                    };
                }
                byDate[dateKey].jobs.push(analysis);
                byDate[dateKey].total_jobs++;
                if (analysis.status === 'passed') {
                    byDate[dateKey].passed_jobs++;
                } else if (analysis.failed_tests > 0) {
                    byDate[dateKey].failed_jobs++;
                }
            });

            // Use the same rendering logic as filtered results
            const formattedData = {
                results: Object.values(byDate)
            };

            // Render based on view mode
            if (currentViewMode === 'pipeline') {
                renderPipelineView(formattedData.results);
            } else {
                renderListView(formattedData.results);
            }
        }

        function renderDashboardOld(data) {
            // Old rendering function kept for reference
            const container = document.getElementById('pipelineContainer');
            container.innerHTML = '';

            const analyses = data.analyses || [];
            analyses.forEach((analysis, index) => {
                const card = document.createElement('div');
                card.className = 'pipeline-card';

                const statusIcon = analysis.status === 'passed' ? '‚úÖ' : (analysis.failed_tests > 0 ? '‚ùå' : '‚ö†Ô∏è');

                const bodyHTML = `
                    <div class="job-item">
                        <div class="job-title">${statusIcon} ${escapeHtml(analysis.job_name)} - Build #${analysis.build_number}</div>
                        <div class="job-meta">
                            Tests: ${analysis.passed_tests}/${analysis.total_tests} passed |
                            Log: ${(analysis.log_size / 1024).toFixed(1)} KB |
                            Type: ${analysis.log_type} |
                            Model: ${analysis.model_used}
                        </div>
                        <div class="analysis">${escapeHtml(analysis.analysis_text || 'No analysis available')}</div>
                    </div>
                `;

                card.innerHTML = `
                    <div class="pipeline-header" onclick="togglePipeline(${index})">
                        <div>
                            <h3>${statusIcon} ${escapeHtml(analysis.job_name)}</h3>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;">
                                ${analysis.jenkins_url || ''} | ${new Date(analysis.analyzed_at).toLocaleString()}
                            </div>
                        </div>
                        <div class="badge">
                            Build #${analysis.build_number}
                        </div>
                    </div>
                    <div class="pipeline-body" id="pipeline-${index}">
                        ${bodyHTML}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function togglePipeline(index) {
            const body = document.getElementById(`pipeline-${index}`);
            body.classList.toggle('expanded');
        }

        function exportResults() {
            if (!currentData) {
                alert('No data to export');
                return;
            }

            const dataStr = JSON.stringify(currentData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `jenkins-dashboard-${currentData.date}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update toggle button
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');

            if (newTheme === 'dark') {
                icon.textContent = 'üåô';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Dark Mode';
            }
        }

        // Initialize theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');

            if (savedTheme === 'dark') {
                icon.textContent = 'üåô';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Dark Mode';
            }
        })();

        // Auto-refresh every 5 minutes
        setInterval(refreshDashboard, 5 * 60 * 1000);

        // Load on page load
        window.addEventListener('DOMContentLoaded', refreshDashboard);
    </script>
</body>
</html>

