<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jenkins Log Analyzer - Admin</title>
    <style>
        :root[data-theme="light"] {
            --bg-primary: #f0f0f0;
            --bg-secondary: white;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --border-color-light: #e0e0e0;
            --accent-color: #335eea;
            --accent-hover: #2347c5;
            --success-bg: #f1f8f4;
            --success-border: #4caf50;
            --error-bg: #fef1f0;
            --error-border: #f44336;
            --warning-bg: #fff8e1;
            --warning-border: #ff9800;
            --shadow: rgba(0,0,0,0.1);
            --progress-bg: #e0e0e0;
            --job-card-bg: white;
        }

        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #242424;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --border-color-light: #353535;
            --accent-color: #5b7cff;
            --accent-hover: #4a6bef;
            --success-bg: #1a2e1a;
            --success-border: #4caf50;
            --error-bg: #2e1a1a;
            --error-border: #f44336;
            --warning-bg: #2e2a1a;
            --warning-border: #ff9800;
            --shadow: rgba(0,0,0,0.3);
            --progress-bg: #404040;
            --job-card-bg: #1f1f1f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            box-shadow: 0 2px 8px var(--shadow);
            z-index: 1000;
            transition: all 0.3s;
            color: var(--text-primary);
            font-weight: 500;
        }
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow);
            border-color: var(--accent-color);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 40px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: background 0.3s;
        }
        h1 { color: var(--text-primary); margin-bottom: 10px; text-align: center; font-size: 2.5em; }
        .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 30px; }
        .step {
            margin-bottom: 25px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--accent-color);
            transition: background 0.3s;
        }
        .step h2 { color: var(--accent-color); margin-bottom: 15px; font-size: 1.2em; }
        input, select, button {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: var(--accent-color); }
        button {
            background: var(--accent-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        button:hover { background: var(--accent-hover); }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .progress-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border: 1px solid var(--border-color-light);
            transition: background 0.3s;
        }
        .progress-section.active { display: block; }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--progress-bg);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
            transition: background 0.3s;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent-color);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .status-message {
            color: var(--accent-color);
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 4px;
            border: 1px solid var(--border-color-light);
            transition: all 0.3s;
        }

        /* Jenkins-style Pipeline View */
        .results-section {
            display: none;
            margin-top: 30px;
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            transition: background 0.3s;
        }
        .results-section.active { display: block; }

        .pipeline-view {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }
        .pipeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color-light);
            margin-bottom: 20px;
        }
        .pipeline-title { font-size: 1.5em; font-weight: bold; color: var(--text-primary); }
        .pipeline-meta { display: flex; gap: 15px; align-items: center; }

        /* Stage boxes with arrows */
        .stages-container { display: flex; align-items: center; gap: 0; margin: 20px 0; overflow-x: auto; padding: 10px 0; }
        .stage-box {
            min-width: 180px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            text-align: center;
            position: relative;
            transition: all 0.3s;
        }
        .stage-box:hover { box-shadow: 0 4px 12px var(--shadow); transform: translateY(-2px); }
        .stage-box.success { border-color: var(--success-border); background: var(--success-bg); }
        .stage-box.failure { border-color: var(--error-border); background: var(--error-bg); }
        .stage-box.unstable { border-color: var(--warning-border); background: var(--warning-bg); }
        .stage-box.running { border-color: #2196f3; background: var(--bg-tertiary); animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .stage-icon { font-size: 2em; margin-bottom: 8px; }
        .stage-box.success .stage-icon { color: var(--success-border); }
        .stage-box.failure .stage-icon { color: var(--error-border); }
        .stage-box.unstable .stage-icon { color: var(--warning-border); }
        .stage-box.running .stage-icon { color: #2196f3; }

        .stage-name { font-weight: bold; color: var(--text-primary); margin-bottom: 5px; font-size: 0.95em; }
        .stage-duration { font-size: 0.85em; color: var(--text-secondary); }

        .arrow {
            width: 40px;
            height: 2px;
            background: var(--border-color);
            position: relative;
            flex-shrink: 0;
        }
        .arrow::after {
            content: '‚ñ∂';
            position: absolute;
            right: -8px;
            top: -9px;
            color: var(--border-color);
            font-size: 12px;
        }

        /* Job cards - Jenkins style */
        .job-card {
            background: var(--job-card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.2s;
        }
        .job-card:hover { box-shadow: 0 2px 8px var(--shadow); }

        .job-header {
            background: var(--bg-tertiary);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color-light);
            transition: background 0.3s;
        }
        .job-header:hover { background: var(--bg-primary); }

        .job-title-section { display: flex; align-items: center; gap: 12px; }
        .build-status-icon { font-size: 1.5em; }
        .job-title { font-size: 1.1em; font-weight: 600; color: var(--text-primary); }
        .job-meta { display: flex; gap: 12px; font-size: 0.9em; align-items: center; color: var(--text-secondary); }
        .job-badge {
            background: var(--border-color-light);
            padding: 4px 10px;
            border-radius: 3px;
            font-size: 0.85em;
            color: var(--text-secondary);
        }
        .job-badge.rca { background: var(--accent-color); color: white; font-weight: 600; }

        .job-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .job-content.expanded { max-height: 5000px; }
        .job-body {
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .expand-icon { transition: transform 0.3s; color: var(--text-secondary); }
        .expanded-header .expand-icon { transform: rotate(180deg); }

        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            transition: all 0.3s;
        }
        .stat-value { font-size: 2.5em; font-weight: bold; color: var(--accent-color); }
        .stat-label { font-size: 0.9em; color: var(--text-secondary); margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content {
            background: var(--bg-secondary);
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            box-shadow: 0 10px 40px var(--shadow);
            transition: background 0.3s;
        }
        .modal-header { color: var(--accent-color); font-size: 1.5em; margin-bottom: 20px; }
        .modal-body { line-height: 1.8; color: var(--text-primary); }
        .modal-body strong { color: var(--accent-color); }
        .modal-body a { color: var(--accent-color); text-decoration: none; font-weight: bold; }
        .modal-body a:hover { text-decoration: underline; }
        .close-btn { float: right; font-size: 28px; font-weight: bold; color: var(--text-secondary); cursor: pointer; }
        .close-btn:hover { color: var(--text-primary); }
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
            border-top: 2px solid var(--border-color-light);
            transition: all 0.3s;
        }
        .footer a { color: var(--accent-color); text-decoration: none; }
        .export-buttons { display: none; margin-top: 20px; gap: 10px; }
        .export-buttons.active { display: flex; }
        .export-btn { flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .export-btn:hover { background: #218838; }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIcon">üåô</span>
        <span id="themeText">Light Mode</span>
    </div>

    <div class="container">
        <h1>üîç Jenkins Log Analyzer - Admin</h1>
        <p class="subtitle">AI-powered analysis with real-time streaming results</p>

        <div style="text-align: right; margin-bottom: 15px;">
            <button onclick="clearCredentials()" style="width: auto; padding: 8px 16px; background: #dc3545; font-size: 14px;">üóëÔ∏è Clear Saved Credentials</button>
        </div>

        <div class="step">
            <h2>Step 1: Enter Groq API Key</h2>
            <input type="password" id="groqApiKey" placeholder="Enter your Groq API key" onchange="saveCredentials()">
            <button onclick="fetchModels()">Fetch Available Models</button>
            <small style="color: #dc3545; margin-top: 10px; display: block;">‚ö†Ô∏è <a href="#" onclick="showDataProtectionModal(); return false;" style="color: #dc3545; text-decoration: underline;">Important: Enable Zero Data Retention in Groq</a></small>
        </div>

        <div class="step">
            <h2>Step 2: Select Model</h2>
            <select id="modelSelect" disabled>
                <option value="">First fetch models...</option>
            </select>
        </div>

        <div class="step">
            <h2>Step 3: Enter Jenkins URL</h2>
            <input type="text" id="jenkinsUrl" placeholder="https://your-jenkins-server.com or https://jenkins.com/job/JobName/" onchange="saveCredentials()">
            <small style="color: #666;">üí° Tip: Use base URL to analyze all jobs, or job-specific URL for single job</small>
        </div>

        <div class="step">
            <h2>Step 4: Analysis Options</h2>
            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" id="analyzeSelectedOnly" style="width: auto; margin: 0;" onchange="toggleSelectedJobInput()">
                    <span><strong>üéØ Analyze Selected Job Only:</strong> Analyze ONLY the specific job (skip pipeline detection)</span>
                </label>
                <div id="selectedJobInputContainer" style="display: none; margin-left: 30px; margin-bottom: 10px;">
                    <input type="text" id="selectedJobName" placeholder="Enter job name (e.g., my-test-job)" style="margin: 0;">
                    <small style="color: #666; display: block; margin-top: 5px;">üí° Enter the exact job name - will NOT analyze the entire pipeline</small>
                </div>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" id="filterFailed" checked style="width: auto; margin: 0;">
                    <span><strong>üîç Smart Filter:</strong> Only analyze failed/unstable jobs (reduces analysis by ~80%)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" id="enableRCA" checked style="width: auto; margin: 0;">
                    <span><strong>üî¨ Root Cause Analysis:</strong> Deep dive into failures with actionable insights</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" id="enableParallel" checked style="width: auto; margin: 0;">
                    <span><strong>üöÄ Parallel Processing:</strong> Use 3 workers for 10x faster analysis</span>
                </label>
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px;">
                    <input type="checkbox" id="enableFallback" checked style="width: auto; margin: 0;">
                    <span><strong>üîÑ Model Fallback:</strong> Automatically try alternative models on errors (uncheck to use only selected model)</span>
                </label>
            </div>
        </div>

        <div class="step">
            <h2>Step 5: Jira Integration (Optional)</h2>
            <div style="margin: 15px 0;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    <input type="checkbox" id="enableJira" style="width: auto; margin: 0;" onchange="toggleJiraFields(); saveCredentials();">
                    <span><strong>üìù Post results to Jira ticket</strong></span>
                </label>
                <div id="jiraFields" style="display: none; margin-top: 10px;">
                    <input type="text" id="jiraUrl" placeholder="Jira URL (e.g., https://your-company.atlassian.net)" style="margin-bottom: 10px;" onchange="saveCredentials()">
                    <input type="text" id="jiraTicket" placeholder="Jira Ticket ID (e.g., PROJ-123)" style="margin-bottom: 10px;" onchange="saveCredentials()">
                    <input type="password" id="jiraPat" placeholder="Jira Personal Access Token (PAT)" style="margin-bottom: 10px;" onchange="saveCredentials()">

                    <label style="display: block; margin-bottom: 5px; color: #666; font-size: 14px;">Jira API Version:</label>
                    <select id="jiraApiVersion" style="margin-bottom: 10px;" onchange="saveCredentials()">
                        <option value="2" selected>API v2 (Default - Better compatibility)</option>
                        <option value="3">API v3 (Newer Jira instances)</option>
                    </select>

                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" id="attachLogFiles" style="width: auto; margin: 0;" onchange="saveCredentials()">
                        <span style="color: #666; font-size: 14px;">üìé Attach AI analysis files to Jira ticket</span>
                    </label>

                    <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" id="attachRawLogs" style="width: auto; margin: 0;" onchange="saveCredentials()">
                        <span style="color: #666; font-size: 14px;">üìã Also attach raw console/debug logs (disabled by default)</span>
                    </label>

                    <small style="color: #666; display: block; margin-top: -5px;">üí° Get PAT from: Jira ‚Üí Profile ‚Üí Personal Access Tokens</small>
                </div>
            </div>
        </div>

        <div class="step">
            <h2>‚è∞ Daily Analysis Schedule</h2>
            <div style="margin: 15px 0;">
                <label style="display: block; margin-bottom: 10px; color: var(--text-secondary); font-size: 14px;">
                    Set the time when daily automated analysis should run:
                </label>
                <input type="time" id="dailyAnalysisTime" value="02:00" style="margin-bottom: 10px;" onchange="saveDailySchedule()">
                <small style="color: var(--text-secondary); display: block; margin-bottom: 15px;">
                    üí° Recommended: Set during off-peak hours (e.g., 2:00 AM). Requires cron job setup.
                </small>
                <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--accent-color);">
                    <strong style="color: var(--text-primary);">üìã Cron Job Setup:</strong>
                    <p style="margin: 10px 0; color: var(--text-secondary); font-size: 14px;">
                        Add this to your crontab to run daily analysis automatically:
                    </p>
                    <code id="cronCommand" style="display: block; padding: 10px; background: #1e1e1e; color: #d4d4d4; border-radius: 4px; font-family: monospace; font-size: 13px; overflow-x: auto;">
                        0 2 * * * curl -X POST http://localhost:5000/api/run-daily-analysis
                    </code>
                    <button onclick="copyCronCommand()" style="width: auto; padding: 8px 16px; margin-top: 10px; background: var(--accent-color); font-size: 14px;">
                        üìã Copy Command
                    </button>
                </div>
            </div>
        </div>

        <div class="step">
            <h2>Step 6: Analyze Logs</h2>
            <button id="analyzeBtn" onclick="analyzeLogs()">Start Analysis</button>
        </div>

        <div id="progressSection" class="progress-section">
            <h3 style="color: #335eea; margin-bottom: 15px;">‚öôÔ∏è Analysis Progress</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%">0%</div>
            </div>
            <div id="statusMessage" class="status-message">Initializing...</div>
        </div>
        
        <div id="resultsSection" class="results-section">
            <!-- Pipeline View Header -->
            <div class="pipeline-view" id="pipelineView" style="display: none;">
                <div class="pipeline-header">
                    <div>
                        <div class="pipeline-title" id="pipelineName">Pipeline Analysis</div>
                        <div style="color: #666; margin-top: 5px;" id="pipelineDesc"></div>
                    </div>
                    <div class="pipeline-meta">
                        <div style="font-size: 0.9em; color: #666;">
                            <span id="pipelineJobCount">0</span> jobs
                        </div>
                    </div>
                </div>

                <!-- Pipeline Stages with Arrows -->
                <div class="stages-container" id="stagesContainer">
                    <!-- Stages will be dynamically added here -->
                </div>
            </div>

            <!-- Summary Stats -->
            <div id="summaryStats" class="summary-stats"></div>

            <!-- Job Results -->
            <div id="jobResults"></div>

            <!-- Export Buttons -->
            <div class="export-buttons" id="exportButtons">
                <button class="export-btn" onclick="exportAsJSON()">üì• Export as JSON</button>
                <button class="export-btn" onclick="exportAsXML()">üßæ Export as XML</button>
                <button class="export-btn" id="postToJiraBtn" onclick="postToJira()" style="background: #0052CC; display: none;">üìù Post to Jira</button>
            </div>
        </div>

	        <div class="footer">
	            <p>Created by <strong>Chandravijay Agrawal</strong> | <a href="https://github.com/ScienceArtist" target="_blank">@ScienceArtist</a></p>
            <p style="margin-top: 10px; font-size: 0.9em;">AI-powered Jenkins Log Analyzer with real-time streaming</p>
        </div>
    </div>

    <!-- Data Protection Modal -->
    <div id="dataProtectionModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDataProtectionModal()">&times;</span>
            <div class="modal-header">üîí Important: Enable Zero Data Retention</div>
            <div class="modal-body">
                <p><strong>To protect your Jenkins logs and data, you MUST enable Zero Data Retention (ZDR) in Groq:</strong></p>
                <ol style="margin: 15px 0; padding-left: 20px;">
                    <li>Visit <a href="https://console.groq.com/settings/data-controls" target="_blank">Groq Data Controls Settings</a></li>
                    <li>Enable <strong>"Global ZDR"</strong> - This prevents Groq from storing any input/output data</li>
                    <li>Enable <strong>"Inference APIs ZDR"</strong> - This opts out of storing API data for 30 days</li>
                </ol>
                <p style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <strong>‚ö†Ô∏è Why this matters:</strong> Without ZDR enabled, your Jenkins logs (which may contain sensitive information) could be stored by Groq for up to 30 days. Enabling ZDR ensures complete data privacy.
                </p>
                <button onclick="closeDataProtectionModal()" style="margin-top: 20px; width: 100%; padding: 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Got it!</button>
            </div>
        </div>
    </div>

	    <script>
        let jobCount = 0, analyzedCount = 0;
        let analysisResults = [];
        let completedJobs = [];  // Track successfully analyzed jobs for retry functionality
        let totalTestsPassed = 0, totalTestsFailed = 0, totalTests = 0;  // Test statistics

        function showDataProtectionModal() {
            document.getElementById('dataProtectionModal').style.display = 'block';
        }

        function closeDataProtectionModal() {
            document.getElementById('dataProtectionModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('dataProtectionModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Check for automation query parameters on page load
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const groqApiKey = urlParams.get('groq_api_key');
            const model = urlParams.get('model');
            const jenkinsUrl = urlParams.get('jenkins_url');

            if (groqApiKey && model && jenkinsUrl) {
                // Auto-fill form fields
                document.getElementById('groqApiKey').value = groqApiKey;
                document.getElementById('jenkinsUrl').value = jenkinsUrl;

                // Trigger async analysis for automation
                triggerAsyncAnalysis(groqApiKey, model, jenkinsUrl);
            }
        });

        async function triggerAsyncAnalysis(apiKey, model, jenkinsUrl) {
            try {
                document.getElementById('statusMessage').textContent = 'Starting async analysis...';
                document.getElementById('progressSection').classList.add('active');

                const res = await fetch('/api/analyze-async', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jenkins_url: jenkinsUrl,
                        groq_api_key: apiKey,
                        model: model
                    })
                });

                const data = await res.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                // Display tracking information
                const trackingInfo = document.createElement('div');
                trackingInfo.style.cssText = 'background: #e7f3ff; border: 2px solid #2196F3; padding: 20px; border-radius: 10px; margin: 20px 0;';
                trackingInfo.innerHTML = `
                    <h3 style="color: #1976D2; margin-top: 0;">üîó Async Analysis Started</h3>
                    <p><strong>Tracking ID:</strong> <code style="background: white; padding: 4px 8px; border-radius: 4px;">${data.tracking_id}</code></p>
                    <p><strong>Status URL:</strong> <a href="${data.status_url}" target="_blank" style="color: #1976D2; word-break: break-all;">${data.status_url}</a></p>
                    <p style="margin-bottom: 0;"><strong>Status:</strong> <span style="color: #ff9800; font-weight: bold;">${data.status}</span></p>
                    <button onclick="pollAsyncStatus('${data.tracking_id}')" style="margin-top: 15px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">üìä Poll Status & Show Results</button>
                `;

                document.getElementById('resultsSection').classList.add('active');
                document.getElementById('resultsSection').insertBefore(trackingInfo, document.getElementById('summaryStats'));

            } catch (e) {
                alert('Error starting async analysis: ' + e.message);
            }
        }

        async function pollAsyncStatus(trackingId) {
            try {
                document.getElementById('statusMessage').textContent = 'Polling analysis status...';

                const res = await fetch(`/api/status/${trackingId}`);
                const data = await res.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }

                document.getElementById('statusMessage').textContent = `Status: ${data.status}`;

                if (data.status === 'complete' && data.results) {
                    // Display results
                    analysisResults = data.results;
                    document.getElementById('jobResults').innerHTML = '';

                    // Show pipeline info if available
                    if (data.pipeline) {
                        document.getElementById('pipelineInfo').style.display = 'block';
                        document.getElementById('pipelineName').textContent = data.pipeline.name;
                        document.getElementById('pipelineDesc').textContent = `Pipeline with ${data.pipeline.job_count} jobs`;
                    }

                    // Display each job result
                    data.results.forEach(result => {
                        const card = document.createElement('div');
                        card.className = 'job-card';
                        card.innerHTML = `
                            <div class="job-header" onclick="this.nextElementSibling.classList.toggle('expanded')">
                                <div class="job-title">${result.job}</div>
                                <div class="job-meta">
                                    <div class="job-badge">Build #${result.build}</div>
                                    <div class="job-badge">${(result.log_size/1024).toFixed(1)}KB</div>
                                    <div class="expand-icon">‚ñº</div>
                                </div>
                            </div>
                            <div class="job-content expanded">
                                <div class="job-body">${result.analysis}</div>
                            </div>
                        `;
                        document.getElementById('jobResults').appendChild(card);
                    });

                    updateStats();
                    document.getElementById('exportButtons').classList.add('active');
                    toggleJiraFields(); // Show Jira button if enabled
                    document.getElementById('statusMessage').textContent = '‚úÖ Analysis complete!';

                } else if (data.status === 'pending' || data.status === 'running') {
                    document.getElementById('statusMessage').textContent = `Status: ${data.status} - Click "Poll Status" again to refresh`;
                } else {
                    document.getElementById('statusMessage').textContent = `Status: ${data.status}`;
                }

            } catch (e) {
                alert('Error polling status: ' + e.message);
            }
        }
        
        function toggleSelectedJobInput() {
            const checkbox = document.getElementById('analyzeSelectedOnly');
            const container = document.getElementById('selectedJobInputContainer');
            const filterFailedCheckbox = document.getElementById('filterFailed');

            if (checkbox.checked) {
                container.style.display = 'block';
                // Disable smart filter when analyzing a specific job
                filterFailedCheckbox.checked = false;
                filterFailedCheckbox.disabled = true;
            } else {
                container.style.display = 'none';
                filterFailedCheckbox.disabled = false;
            }
        }

        async function fetchModels() {
            const apiKey = document.getElementById('groqApiKey').value;
            if (!apiKey) { alert('Enter API key'); return; }
            try {
                const res = await fetch('/api/models', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({groq_api_key: apiKey}) });
                const data = await res.json();
                if (data.error) { alert('Error: ' + data.error); return; }
                const select = document.getElementById('modelSelect');
                select.innerHTML = '<option value="">Select model...</option>';
                let defaultFound = false;
                data.models.forEach((m, index) => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.name;
                    // Set gpt-oss-120b as default, or first model if not found
                    if (m.id === 'gpt-oss-120b' || (!defaultFound && index === 0)) {
                        opt.selected = true;
                        defaultFound = true;
                    }
                    select.appendChild(opt);
                });
                select.disabled = false;
                const selectedModel = select.options[select.selectedIndex].value;
                alert(`‚úì Models loaded! Default: ${selectedModel}`);
            } catch (e) { alert('Error: ' + e.message); }
        }
        
        async function analyzeLogs() {
            const apiKey = document.getElementById('groqApiKey').value;
            const model = document.getElementById('modelSelect').value;
            const jenkinsUrl = document.getElementById('jenkinsUrl').value;

            // Get optimization options
            const analyzeSelectedOnly = document.getElementById('analyzeSelectedOnly').checked;
            const selectedJobName = document.getElementById('selectedJobName').value;
            const filterFailed = document.getElementById('filterFailed').checked;
            const enableRCA = document.getElementById('enableRCA').checked;
            const enableParallel = document.getElementById('enableParallel').checked;
            const enableFallback = document.getElementById('enableFallback').checked;
            const parallelWorkers = enableParallel ? 3 : 1;

            if (!apiKey || !model || !jenkinsUrl) { alert('Complete all steps'); return; }

            // Validate selected job name if checkbox is checked
            if (analyzeSelectedOnly && !selectedJobName.trim()) {
                alert('Please enter a job name to analyze');
                return;
            }

            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('resultsSection').classList.add('active');

            // Check if this is a retry (button text changed to "Retry Analysis")
            const isRetry = document.getElementById('analyzeBtn').textContent.includes('Retry');

            if (!isRetry) {
                // Fresh analysis - clear everything
                document.getElementById('jobResults').innerHTML = '';
                jobCount = 0; analyzedCount = 0;
                analysisResults = []; // Reset results
                completedJobs = []; // Reset completed jobs list
                totalTestsPassed = 0; totalTestsFailed = 0; totalTests = 0; // Reset test statistics
                document.getElementById('analyzeBtn').textContent = 'Start Analysis'; // Reset button text
            }
            // If retry, keep existing results and completed jobs list

            document.getElementById('exportButtons').classList.remove('active');
            try {
                const requestBody = {
                    jenkins_url: jenkinsUrl,
                    groq_api_key: apiKey,
                    model: model,
                    filter_failed: filterFailed,
                    enable_rca: enableRCA,
                    enable_fallback: enableFallback,
                    parallel_workers: parallelWorkers
                };

                // Add selected job name if checkbox is checked
                if (analyzeSelectedOnly && selectedJobName.trim()) {
                    requestBody.specific_job = selectedJobName.trim();
                }

                // Add completed jobs list for retry functionality
                if (isRetry && completedJobs.length > 0) {
                    requestBody.completed_jobs = completedJobs;
                }

                const res = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });
                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = JSON.parse(line.substring(6));
                            if (data.type === 'status') document.getElementById('statusMessage').textContent = data.message;
                            else if (data.type === 'optimization') {
                                // Show optimization message
                                document.getElementById('statusMessage').textContent = data.message;
                            }
                            else if (data.type === 'pipeline_info') {
                                document.getElementById('pipelineView').style.display = 'block';
                                document.getElementById('pipelineName').textContent = 'üîó ' + data.pipeline;
                                document.getElementById('pipelineDesc').textContent = `Analyzing ${data.job_count} jobs in this pipeline`;
                                document.getElementById('pipelineJobCount').textContent = data.job_count;
                            }
                            else if (data.type === 'progress') {
                                jobCount = data.total; analyzedCount = data.current;
                                const pct = Math.round((data.current / data.total) * 100);
                                document.getElementById('progressFill').style.width = pct + '%';
                                document.getElementById('progressFill').textContent = pct + '%';
                                document.getElementById('statusMessage').textContent = `Analyzing ${data.job} (${data.current}/${data.total})`;
                            }
                            else if (data.type === 'job_result') {
                                // Check for rate limit error
                                if (data.analysis && data.analysis.includes('RATE_LIMIT_STOP|||')) {
                                    const parts = data.analysis.split('|||');
                                    const resetInfo = parts[1] || 'Reset time unknown';
                                    const errorMsg = parts[2] || 'Rate limit exceeded';

                                    // Stop the stream
                                    reader.cancel();

                                    // Show rate limit message
                                    document.getElementById('statusMessage').innerHTML = `
                                        <div style="color: #ff9800; font-weight: bold;">
                                            ‚è∏Ô∏è Analysis Paused - Rate Limit Reached<br>
                                            <span style="font-size: 0.9em;">Will automatically retry: ${resetInfo}</span><br>
                                            <span style="font-size: 0.8em; color: #666;">${errorMsg}</span>
                                        </div>
                                    `;
                                    document.getElementById('analyzeBtn').disabled = false;
                                    document.getElementById('analyzeBtn').textContent = 'Retry Analysis';

                                    // Show a prominent alert
                                    alert(`‚è∏Ô∏è Rate Limit Reached!\n\nAnalysis will automatically retry: ${resetInfo}\n\nYou can:\n1. Wait and click "Retry Analysis" button\n2. Try a different model\n3. Enable "Model Fallback" to use alternative models`);
                                    return;
                                }

                                // Check if this job already exists in results (for retry scenario)
                                const existingIndex = analysisResults.findIndex(r => r.job === data.job);
                                const resultData = {
                                    job: data.job,
                                    build: data.build,
                                    analysis: data.analysis,
                                    log_size: data.log_size,
                                    mode: data.mode || 'Analysis',
                                    timestamp: new Date().toISOString(),
                                    status: data.status,
                                    passed_tests: data.passed_tests || 0,
                                    total_tests: data.total_tests || 0
                                };

                                if (existingIndex >= 0) {
                                    // Update existing result (retry scenario)
                                    analysisResults[existingIndex] = resultData;
                                } else {
                                    // Add new result
                                    analysisResults.push(resultData);
                                }

                                // Track completed job for retry functionality
                                // Add to completedJobs if the analysis completed (even if it found failures)
                                // Only skip if there was an ERROR in the analysis process itself
                                const hasAnalysisError = data.analysis.startsWith('Error:') ||
                                                         data.analysis.includes('Rate limit reached') ||
                                                         data.analysis.includes('All models failed') ||
                                                         data.status === 'error';

                                if (!hasAnalysisError && !completedJobs.includes(data.job)) {
                                    completedJobs.push(data.job);
                                }

                                // Update test statistics
                                if (data.status === 'passed' && data.passed_tests && data.total_tests) {
                                    totalTestsPassed += data.passed_tests;
                                    totalTests += data.total_tests;
                                }

                                // Determine build status from analysis
                                const analysisLower = data.analysis.toLowerCase();
                                let buildStatus = 'success';
                                let statusIcon = 'üîµ';

                                // Check if this is a passed job (all tests passed)
                                if (data.status === 'passed' || analysisLower.includes('all tests passed')) {
                                    buildStatus = 'success';
                                    statusIcon = '‚úÖ';
                                } else if (analysisLower.includes('failure') || analysisLower.includes('failed')) {
                                    buildStatus = 'failure';
                                    statusIcon = 'üî¥';
                                } else if (analysisLower.includes('unstable') || analysisLower.includes('warning')) {
                                    buildStatus = 'unstable';
                                    statusIcon = 'üü°';
                                }

                                const modeLabel = data.mode || 'üìä Analysis';
                                const isRCA = modeLabel.includes('RCA');

                                // Check if a card already exists for this job (retry scenario)
                                const jobResults = document.getElementById('jobResults');
                                const existingCards = jobResults.querySelectorAll('.job-card');
                                let existingCard = null;

                                existingCards.forEach(card => {
                                    const jobTitle = card.querySelector('.job-title');
                                    if (jobTitle && jobTitle.textContent === data.job) {
                                        existingCard = card;
                                    }
                                });

                                const cardHTML = `
                                    <div class="job-header" onclick="toggleJobCard(this)">
                                        <div class="job-title-section">
                                            <span class="build-status-icon">${statusIcon}</span>
                                            <span class="job-title">${data.job}</span>
                                        </div>
                                        <div class="job-meta">
                                            ${isRCA ? '<div class="job-badge rca">üî¨ RCA</div>' : '<div class="job-badge">üìä Analysis</div>'}
                                            <div class="job-badge">Build #${data.build}</div>
                                            <div class="job-badge">${(data.log_size/1024).toFixed(1)}KB</div>
                                            <span class="expand-icon">‚ñº</span>
                                        </div>
                                    </div>
                                    <div class="job-content">
                                        <div class="job-body">${escapeHtml(data.analysis)}</div>
                                    </div>
                                `;

                                if (existingCard) {
                                    // Update existing card
                                    existingCard.innerHTML = cardHTML;
                                } else {
                                    // Create new card
                                    const card = document.createElement('div');
                                    card.className = 'job-card';
                                    card.innerHTML = cardHTML;
                                    jobResults.appendChild(card);
                                }

                                updateStats();
                            }
                            else if (data.type === 'complete') {
                                document.getElementById('statusMessage').textContent = '‚úÖ ' + data.message;
                                document.getElementById('progressFill').style.width = '100%';
                                document.getElementById('progressFill').textContent = '100%';
                                document.getElementById('exportButtons').classList.add('active'); // Show export buttons
                                toggleJiraFields(); // Show Jira button if enabled

                                // Show pipeline view for all analyses
                                if (analysisResults.length > 0) {
                                    document.getElementById('pipelineView').style.display = 'block';
                                    document.getElementById('pipelineName').textContent = 'üìä Analysis Results';
                                    document.getElementById('pipelineDesc').textContent = `Completed analysis of ${analysisResults.length} jobs`;
                                    document.getElementById('pipelineJobCount').textContent = analysisResults.length;
                                    updatePipelineStages();
                                }
                            }
                        }
                    }
                }
            } catch (e) {
                // On error, enable retry functionality
                document.getElementById('statusMessage').innerHTML = `
                    <div style="color: #f44336; font-weight: bold;">
                        ‚ùå Error: ${e.message}<br>
                        <span style="font-size: 0.9em;">Click "Retry Analysis" to continue from where it failed</span>
                    </div>
                `;
                document.getElementById('analyzeBtn').textContent = 'Retry Analysis';
                alert('Error: ' + e.message);
            }
            document.getElementById('analyzeBtn').disabled = false;
        }
        
        function toggleJobCard(headerElement) {
            const content = headerElement.nextElementSibling;
            content.classList.toggle('expanded');
            headerElement.classList.toggle('expanded-header');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateStats() {
            const stats = document.getElementById('summaryStats');

            // Calculate success/failure counts
            let passedJobsCount = 0;  // Jobs with all tests passed (skipped AI)
            let failedJobsCount = 0;  // Jobs with failures (analyzed by AI)
            let unstableCount = 0;

            analysisResults.forEach(result => {
                const analysisLower = result.analysis.toLowerCase();
                if (result.status === 'passed' || analysisLower.includes('all tests passed')) {
                    passedJobsCount++;
                } else if (analysisLower.includes('failure') || analysisLower.includes('failed')) {
                    failedJobsCount++;
                } else if (analysisLower.includes('unstable') || analysisLower.includes('warning')) {
                    unstableCount++;
                }
            });

            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${analyzedCount}</div>
                    <div class="stat-label">Total Jobs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #4caf50;">${passedJobsCount}</div>
                    <div class="stat-label">All Tests Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #f44336;">${failedJobsCount}</div>
                    <div class="stat-label">Jobs with Failures</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: #ff9800;">${unstableCount}</div>
                    <div class="stat-label">Unstable</div>
                </div>
                <div class="stat-card" style="border-left: 2px solid #2196f3; padding-left: 15px;">
                    <div class="stat-value" style="color: #2196f3;">${totalTests}</div>
                    <div class="stat-label">Total Tests (${totalTestsPassed} passed)</div>
                </div>
            `;

            // Update pipeline stages
            updatePipelineStages();
        }

        function updatePipelineStages() {
            const container = document.getElementById('stagesContainer');
            if (!container || analysisResults.length === 0) return;

            container.innerHTML = '';

            // Create stages for each job
            analysisResults.forEach((result, index) => {
                // Determine status
                const analysisLower = result.analysis.toLowerCase();
                let status = 'success';
                let icon = '‚úì';
                if (analysisLower.includes('failure') || analysisLower.includes('failed')) {
                    status = 'failure';
                    icon = '‚úó';
                } else if (analysisLower.includes('unstable') || analysisLower.includes('warning')) {
                    status = 'unstable';
                    icon = '‚ö†';
                }

                // Create stage box
                const stage = document.createElement('div');
                stage.className = `stage-box ${status}`;
                stage.innerHTML = `
                    <div class="stage-icon">${icon}</div>
                    <div class="stage-name">${result.job}</div>
                    <div class="stage-duration">Build #${result.build}</div>
                `;

                container.appendChild(stage);

                // Add arrow if not last item
                if (index < analysisResults.length - 1) {
                    const arrow = document.createElement('div');
                    arrow.className = 'arrow';
                    container.appendChild(arrow);
                }
            });
        }

	        function escapeXml(unsafe) {
	            if (unsafe == null) return '';
	            return unsafe
	                .replace(/&/g, '&amp;')
	                .replace(/</g, '&lt;')
	                .replace(/>/g, '&gt;')
	                .replace(/"/g, '&quot;')
	                .replace(/'/g, '&apos;');
	        }

        function exportAsJSON() {
            if (analysisResults.length === 0) {
                alert('No analysis results to export');
                return;
            }
            const dataStr = JSON.stringify(analysisResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `jenkins-analysis-${new Date().toISOString().replace(/:/g, '-')}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

	        function exportAsXML() {
	            if (analysisResults.length === 0) {
	                alert('No analysis results to export');
	                return;
	            }

	            let xml = '<?xml version="1.0" encoding="UTF-8"?>\n<analysisResults>\n';
	            analysisResults.forEach((result) => {
	                xml += '  <jobResult>\n';
	                xml += `    <job>${escapeXml(result.job)}</job>\n`;
	                xml += `    <build>${escapeXml(String(result.build))}</build>\n`;
	                xml += `    <logSize>${result.log_size}</logSize>\n`;
	                xml += `    <timestamp>${escapeXml(result.timestamp)}</timestamp>\n`;
	                xml += `    <analysis>${escapeXml(result.analysis)}</analysis>\n`;
	                xml += '  </jobResult>\n';
	            });
	            xml += '</analysisResults>\n';

	            const dataBlob = new Blob([xml], {type: 'application/xml'});
	            const url = URL.createObjectURL(dataBlob);
	            const link = document.createElement('a');
	            link.href = url;
	            link.download = `jenkins-analysis-${new Date().toISOString().replace(/:/g, '-')}.xml`;
	            link.click();
	            URL.revokeObjectURL(url);
	        }

        // Save credentials to localStorage
        function saveCredentials() {
            try {
                localStorage.setItem('groqApiKey', document.getElementById('groqApiKey').value);
                localStorage.setItem('jenkinsUrl', document.getElementById('jenkinsUrl').value);
                localStorage.setItem('jiraUrl', document.getElementById('jiraUrl').value);
                localStorage.setItem('jiraTicket', document.getElementById('jiraTicket').value);
                localStorage.setItem('jiraPat', document.getElementById('jiraPat').value);
                localStorage.setItem('enableJira', document.getElementById('enableJira').checked);
                localStorage.setItem('jiraApiVersion', document.getElementById('jiraApiVersion').value);
                localStorage.setItem('attachLogFiles', document.getElementById('attachLogFiles').checked);
                localStorage.setItem('attachRawLogs', document.getElementById('attachRawLogs').checked);
            } catch (e) {
                console.error('Failed to save credentials:', e);
            }
        }

        // Load credentials from localStorage
        function loadCredentials() {
            try {
                const groqApiKey = localStorage.getItem('groqApiKey');
                if (groqApiKey) document.getElementById('groqApiKey').value = groqApiKey;

                const jenkinsUrl = localStorage.getItem('jenkinsUrl');
                if (jenkinsUrl) document.getElementById('jenkinsUrl').value = jenkinsUrl;

                const jiraUrl = localStorage.getItem('jiraUrl');
                if (jiraUrl) document.getElementById('jiraUrl').value = jiraUrl;

                const jiraTicket = localStorage.getItem('jiraTicket');
                if (jiraTicket) document.getElementById('jiraTicket').value = jiraTicket;

                const jiraPat = localStorage.getItem('jiraPat');
                if (jiraPat) document.getElementById('jiraPat').value = jiraPat;

                const jiraApiVersion = localStorage.getItem('jiraApiVersion');
                if (jiraApiVersion) document.getElementById('jiraApiVersion').value = jiraApiVersion;

                const attachLogFiles = localStorage.getItem('attachLogFiles') === 'true';
                if (attachLogFiles) document.getElementById('attachLogFiles').checked = true;

                const attachRawLogs = localStorage.getItem('attachRawLogs') === 'true';
                if (attachRawLogs) document.getElementById('attachRawLogs').checked = true;

                const enableJira = localStorage.getItem('enableJira') === 'true';
                if (enableJira) {
                    document.getElementById('enableJira').checked = true;
                    toggleJiraFields();
                }

                // Load daily analysis schedule
                const dailyAnalysisTime = localStorage.getItem('dailyAnalysisTime');
                if (dailyAnalysisTime) {
                    document.getElementById('dailyAnalysisTime').value = dailyAnalysisTime;
                    updateCronCommand(dailyAnalysisTime);
                }
            } catch (e) {
                console.error('Failed to load credentials:', e);
            }
        }

        // Clear saved credentials
        function clearCredentials() {
            if (confirm('Are you sure you want to clear all saved credentials?')) {
                try {
                    localStorage.removeItem('groqApiKey');
                    localStorage.removeItem('jenkinsUrl');
                    localStorage.removeItem('jiraUrl');
                    localStorage.removeItem('jiraTicket');
                    localStorage.removeItem('jiraPat');
                    localStorage.removeItem('enableJira');
                    localStorage.removeItem('jiraApiVersion');
                    localStorage.removeItem('attachLogFiles');
                    localStorage.removeItem('attachRawLogs');

                    document.getElementById('groqApiKey').value = '';
                    document.getElementById('jenkinsUrl').value = '';
                    document.getElementById('jiraUrl').value = '';
                    document.getElementById('jiraTicket').value = '';
                    document.getElementById('jiraPat').value = '';
                    document.getElementById('enableJira').checked = false;
                    document.getElementById('jiraApiVersion').value = '2';
                    document.getElementById('attachLogFiles').checked = false;
                    document.getElementById('attachRawLogs').checked = false;
                    toggleJiraFields();

                    alert('‚úÖ Credentials cleared!');
                } catch (e) {
                    console.error('Failed to clear credentials:', e);
                }
            }
        }

        // Save daily analysis schedule
        function saveDailySchedule() {
            try {
                const time = document.getElementById('dailyAnalysisTime').value;
                localStorage.setItem('dailyAnalysisTime', time);

                // Update cron command
                updateCronCommand(time);

                // Show confirmation
                alert('‚úÖ Schedule saved! Remember to update your cron job.');
            } catch (e) {
                console.error('Failed to save schedule:', e);
            }
        }

        // Update cron command based on selected time
        function updateCronCommand(time) {
            if (!time) return;

            const [hours, minutes] = time.split(':');
            const cronCommand = `${minutes} ${hours} * * * curl -X POST http://localhost:5000/api/run-daily-analysis`;
            document.getElementById('cronCommand').textContent = cronCommand;
        }

        // Copy cron command to clipboard
        function copyCronCommand() {
            const command = document.getElementById('cronCommand').textContent;
            navigator.clipboard.writeText(command).then(() => {
                alert('‚úÖ Cron command copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                alert('‚ùå Failed to copy. Please copy manually.');
            });
        }

        function toggleJiraFields() {
            const enabled = document.getElementById('enableJira').checked;
            document.getElementById('jiraFields').style.display = enabled ? 'block' : 'none';
            const jiraBtn = document.getElementById('postToJiraBtn');
            if (enabled && analysisResults.length > 0) {
                jiraBtn.style.display = 'block';
            } else {
                jiraBtn.style.display = 'none';
            }
        }

        async function postToJira() {
            const jiraUrl = document.getElementById('jiraUrl').value;
            const jiraTicket = document.getElementById('jiraTicket').value;
            const jiraPat = document.getElementById('jiraPat').value;

            if (!jiraUrl || !jiraTicket || !jiraPat) {
                alert('Please fill in all Jira fields (URL, Ticket ID, and PAT)');
                return;
            }

            if (analysisResults.length === 0) {
                alert('No analysis results to post');
                return;
            }

            const btn = document.getElementById('postToJiraBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Posting to Jira...';

            try {
                const jiraApiVersion = document.getElementById('jiraApiVersion').value;
                const attachLogFiles = document.getElementById('attachLogFiles').checked;
                const attachRawLogs = document.getElementById('attachRawLogs').checked;

                // Get Jenkins URL for Robot Framework links
                const jenkinsUrl = document.getElementById('jenkinsUrl').value;

                const res = await fetch('/api/post-to-jira', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        jira_url: jiraUrl,
                        jira_ticket: jiraTicket,
                        jira_pat: jiraPat,
                        api_version: jiraApiVersion,
                        attach_logs: attachLogFiles,
                        attach_raw_logs: attachRawLogs,
                        jenkins_url: jenkinsUrl,
                        analysis_results: analysisResults
                    })
                });

                const data = await res.json();

                if (data.error) {
                    alert('‚ùå Error posting to Jira: ' + data.error);
                } else {
                    const ticket = data.jira_ticket || jiraTicket;
                    const commentId = data.comment_id || 'created';
                    let message = '‚úÖ Successfully posted analysis to Jira ticket ' + ticket + '!';
                    if (commentId && commentId !== 'created') {
                        message += '\n\nComment ID: ' + commentId;
                    }
                    if (data.attachments_count) {
                        message += '\n\nüìé Attached ' + data.attachments_count + ' analysis file(s)';
                    }
                    alert(message);
                }
            } catch (e) {
                alert('‚ùå Error: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìù Post to Jira';
            }
        }

        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Update toggle button
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');

            if (newTheme === 'dark') {
                icon.textContent = 'üåô';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Dark Mode';
            }
        }

        // Initialize theme on page load
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');

            if (savedTheme === 'dark') {
                icon.textContent = 'üåô';
                text.textContent = 'Light Mode';
            } else {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Dark Mode';
            }
        })();

        // Load credentials when page loads
        window.addEventListener('DOMContentLoaded', loadCredentials);
    </script>
</body>
</html>